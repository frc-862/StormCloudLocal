"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _errors = _interopRequireDefault(require("../lib/errors"));

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _util = require("../lib/util");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let Command;
/**
 * Matches
 *
 * @type {RegExp}
 */

const jsRegExp = /\.js$/;
/**
 * Stores a map of `Command` instances that have been registered for a context.
 *
 * @extends {Map}
 */

class CommandMap extends Map {
  /**
   * Declares the class name.
   *
   * @access public
   */
  constructor() {
    super();
    (0, _util.declareCLIKitClass)(this, 'CommandMap');
  }
  /**
   * Adds a command to the map.
   *
   * @param {Object|String|Command|CommandMap|Array.<Object|String|Command>} cmd - An object used
   * for `Command` constructor params, a path to a directory or a `.js` file, a `Command`
   * instance, or an array of those types. May also be a `CommandMap` instance. If `cmd` is a
   * `String` and `params` is present, then it will treat `cmd` as the command name, not a file
   * path.
   * @param {Object|Function} [params] - When `cmd` is the command name, then this is the options
   * to pass into the `Command` constructor.
   * @param {Boolean} [clone] - When `true` and `cmd` is a `Command` or `CommandMap`, it will
   * clone the `Command` instead of set by reference.
   * @returns {Array.<Command>}
   * @access public
   */


  add(cmd, params, clone) {
    if (!cmd) {
      throw _errors.default.INVALID_ARGUMENT('Invalid command', {
        name: 'cmd',
        scope: 'CommandMap.add',
        value: cmd
      });
    }

    if (!Command) {
      Command = require('./command').default;
    }

    if (params !== undefined && params !== null) {
      if (typeof cmd !== 'string') {
        throw _errors.default.INVALID_ARGUMENT('Command parameters are only allowed when command is a string', {
          name: 'cmd',
          scope: 'CommandMap.add',
          value: {
            cmd,
            params
          }
        });
      } else if (typeof params === 'function') {
        params = {
          action: params
        };
      } else if (typeof params !== 'object') {
        throw _errors.default.INVALID_ARGUMENT('Expected command parameters to be an object or function', {
          name: 'params',
          scope: 'CommandMap.add',
          value: {
            cmd,
            params
          }
        });
      }

      cmd = new Command(cmd, params);
    }

    const results = [];
    const commands = typeof cmd === 'object' && cmd.clikit instanceof Set && (cmd.clikit.has('CommandList') || cmd.clikit.has('CommandMap')) ? cmd.values() : Array.isArray(cmd) ? cmd : [cmd];

    for (let it of commands) {
      cmd = null;

      if (!clone && it instanceof Command) {
        cmd = it;
      } else if (typeof it === 'string') {
        // path
        it = _path.default.resolve(it);

        try {
          const files = _fs.default.statSync(it).isDirectory() ? _fs.default.readdirSync(it).map(filename => _path.default.join(it, filename)) : [it];

          for (const file of files) {
            if (jsRegExp.test(file)) {
              cmd = new Command(file);
              this.set(cmd.name, cmd);
              results.push(cmd);
            }
          }
        } catch (e) {
          if (e.code === 'ENOENT') {
            throw _errors.default.FILE_NOT_FOUND(`Command path does not exist: ${it}`, {
              name: 'command',
              scope: 'CommandMap.add',
              value: it
            });
          }

          throw e;
        }

        continue;
      } else if (it && typeof it === 'object') {
        // ctor params or Command-like
        if (it.clikit instanceof Set) {
          if (it.clikit.has('Extension')) {
            // actions and extensions not supported here
            continue;
          } else if (it.clikit.has('Command')) {
            cmd = new Command(it.name, it);
          } else {
            throw _errors.default.INVALID_COMMAND(`Invalid command: cli-kit type "${Array.from(it.clikit)[0]}" not supported`, {
              name: 'command',
              scope: 'CommandMap.add',
              value: it
            });
          }
        } else if (it.name && typeof it.name === 'string') {
          // the object is command ctor params
          cmd = new Command(it.name, it);
        } else {
          // an object of command names to a path, ctor params, Command object, or Command-like object
          for (const [name, value] of Object.entries(it)) {
            cmd = new Command(name, value);
            this.set(cmd.name, cmd);
            results.push(cmd);
          }

          continue;
        }
      }

      if (cmd instanceof Command) {
        this.set(cmd.name, cmd);
        results.push(cmd);
      } else {
        throw _errors.default.INVALID_ARGUMENT(`Invalid command "${it}", expected an object`, {
          name: 'command',
          scope: 'CommandMap.add',
          value: it
        });
      }
    }

    return results;
  }
  /**
   * Returns the number of commands.
   *
   * @returns {Number}
   * @access public
   */


  get count() {
    return this.size;
  }
  /**
   * Generates an object containing the commands for the help screen.
   *
   * @returns {Object}
   * @access public
   */


  generateHelp() {
    const entries = [];

    for (const cmd of Array.from(this.keys())) {
      const {
        aliases,
        clikitHelp,
        desc,
        hidden,
        name
      } = this.get(cmd);

      if (!hidden && !clikitHelp) {
        const labels = new Set([name]);

        for (const [alias, display] of Object.entries(aliases)) {
          if (display === 'visible') {
            labels.add(alias);
          }
        }

        entries.push({
          name,
          desc,
          label: Array.from(labels).sort((a, b) => {
            return a.length === b.length ? a.localeCompare(b) : a.length - b.length;
          }).join(', '),
          aliases: aliases ? Object.keys(aliases) : null
        });
      }
    }

    entries.sort((a, b) => a.label.localeCompare(b.label));
    return {
      count: entries.length,
      entries
    };
  }

}

exports.default = CommandMap;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhcnNlci9jb21tYW5kLW1hcC5qcyJdLCJuYW1lcyI6WyJDb21tYW5kIiwianNSZWdFeHAiLCJDb21tYW5kTWFwIiwiTWFwIiwiY29uc3RydWN0b3IiLCJhZGQiLCJjbWQiLCJwYXJhbXMiLCJjbG9uZSIsIkUiLCJJTlZBTElEX0FSR1VNRU5UIiwibmFtZSIsInNjb3BlIiwidmFsdWUiLCJyZXF1aXJlIiwiZGVmYXVsdCIsInVuZGVmaW5lZCIsImFjdGlvbiIsInJlc3VsdHMiLCJjb21tYW5kcyIsImNsaWtpdCIsIlNldCIsImhhcyIsInZhbHVlcyIsIkFycmF5IiwiaXNBcnJheSIsIml0IiwicGF0aCIsInJlc29sdmUiLCJmaWxlcyIsImZzIiwic3RhdFN5bmMiLCJpc0RpcmVjdG9yeSIsInJlYWRkaXJTeW5jIiwibWFwIiwiZmlsZW5hbWUiLCJqb2luIiwiZmlsZSIsInRlc3QiLCJzZXQiLCJwdXNoIiwiZSIsImNvZGUiLCJGSUxFX05PVF9GT1VORCIsIklOVkFMSURfQ09NTUFORCIsImZyb20iLCJPYmplY3QiLCJlbnRyaWVzIiwiY291bnQiLCJzaXplIiwiZ2VuZXJhdGVIZWxwIiwia2V5cyIsImFsaWFzZXMiLCJjbGlraXRIZWxwIiwiZGVzYyIsImhpZGRlbiIsImdldCIsImxhYmVscyIsImFsaWFzIiwiZGlzcGxheSIsImxhYmVsIiwic29ydCIsImEiLCJiIiwibGVuZ3RoIiwibG9jYWxlQ29tcGFyZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUVBOzs7O0FBRUEsSUFBSUEsT0FBSjtBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBQ0EsTUFBTUMsUUFBUSxHQUFHLE9BQWpCO0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFDZSxNQUFNQyxVQUFOLFNBQXlCQyxHQUF6QixDQUE2QjtBQUMzQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0NDLEVBQUFBLFdBQVcsR0FBRztBQUNiO0FBQ0Esa0NBQW1CLElBQW5CLEVB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QUNDLENBQUQsRUFBSUMsQ0FBSixLQUFVO0FBQ3hDLG1CQUFPRCxDQUFDLENBQUNFLE1BQUYsS0FBYUQsQ0FBQyxDQUFDQyxNQUFmLEdBQXdCRixDQUFDLENBQUNHLGFBQUYsQ0FBZ0JGLENBQWhCLENBQXhCLEdBQTZDRCxDQUFDLENBQUNFLE1BQUYsR0FBV0QsQ0FBQyxDQUFDQyxNQUFqRTtBQUNBLFdBRk0sRUFFSjVCLElBRkksQ0FFQyxJQUZELENBSEs7QUFNWmdCLFVBQUFBLE9BQU8sRUFBRUEsT0FBTyxHQUFHTixNQUFNLENBQUNLLElBQVAsQ0FBWUMsT0FBWixDQUFILEdBQTBCO0FBTjlCLFNBQWI7QUFRQTtBQUNEOztBQUVETCxJQUFBQSxPQUFPLENBQUNjLElBQVIsQ0FBYSxDQUFDQyxDQUFELEVBQUlDLENBQUosS0FBVUQsQ0FBQyxDQUFDRixLQUFGLENBQVFLLGFBQVIsQ0FBc0JGLENBQUMsQ0FBQ0gsS0FBeEIsQ0FBdkI7QUFFQSxXQUFPO0FBQ05aLE1BQUFBLEtBQUssRUFBRUQsT0FBTyxDQUFDaUIsTUFEVDtBQUVOakIsTUFBQUE7QUFGTSxLQUFQO0FBSUE7O0FBbkswQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBFIGZyb20gJy4uL2xpYi9lcnJvcnMnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgeyBkZWNsYXJlQ0xJS2l0Q2xhc3MgfSBmcm9tICcuLi9saWIvdXRpbCc7XG5cbmxldCBDb21tYW5kO1xuXG4vKipcbiAqIE1hdGNoZXNcbiAqXG4gKiBAdHlwZSB7UmVnRXhwfVxuICovXG5jb25zdCBqc1JlZ0V4cCA9IC9cXC5qcyQvO1xuXG4vKipcbiAqIFN0b3JlcyBhIG1hcCBvZiBgQ29tbWFuZGAgaW5zdGFuY2VzIHRoYXQgaGF2ZSBiZWVuIHJlZ2lzdGVyZWQgZm9yIGEgY29udGV4dC5cbiAqXG4gKiBAZXh0ZW5kcyB7TWFwfVxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDb21tYW5kTWFwIGV4dGVuZHMgTWFwIHtcblx0LyoqXG5cdCAqIERlY2xhcmVzIHRoZSBjbGFzcyBuYW1lLlxuXHQgKlxuXHQgKiBAYWNjZXNzIHB1YmxpY1xuXHQgKi9cblx0Y29uc3RydWN0b3IoKSB7XG5cdFx0c3VwZXIoKTtcblx0XHRkZWNsYXJlQ0xJS2l0Q2xhc3ModGhpcywgJ0NvbW1hbmRNYXAnKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBBZGRzIGEgY29tbWFuZCB0byB0aGUgbWFwLlxuXHQgKlxuXHQgKiBAcGFyYW0ge09iamVjdHxTdHJpbmd8Q29tbWFuZHxDb21tYW5kTWFwfEFycmF5LjxPYmplY3R8U3RyaW5nfENvbW1hbmQ+fSBjbWQgLSBBbiBvYmplY3QgdXNlZFxuXHQgKiBmb3IgYENvbW1hbmRgIGNvbnN0cnVjdG9yIHBhcmFtcywgYSBwYXRoIHRvIGEgZGlyZWN0b3J5IG9yIGEgYC5qc2AgZmlsZSwgYSBgQ29tbWFuZGBcblx0ICogaW5zdGFuY2UsIG9yIGFuIGFycmF5IG9mIHRob3NlIHR5cGVzLiBNYXkgYWxzbyBiZSBhIGBDb21tYW5kTWFwYCBpbnN0YW5jZS4gSWYgYGNtZGAgaXMgYVxuXHQgKiBgU3RyaW5nYCBhbmQgYHBhcmFtc2AgaXMgcHJlc2VudCwgdGhlbiBpdCB3aWxsIHRyZWF0IGBjbWRgIGFzIHRoZSBjb21tYW5kIG5hbWUsIG5vdCBhIGZpbGVcblx0ICogcGF0aC5cblx0ICogQHBhcmFtIHtPYmplY3R8RnVuY3Rpb259IFtwYXJhbXNdIC0gV2hlbiBgY21kYCBpcyB0aGUgY29tbWFuZCBuYW1lLCB0aGVuIHRoaXMgaXMgdGhlIG9wdGlvbnNcblx0ICogdG8gcGFzcyBpbnRvIHRoZSBgQ29tbWFuZGAgY29uc3RydWN0b3IuXG5cdCAqIEBwYXJhbSB7Qm9vbGVhbn0gW2Nsb25lXSAtIFdoZW4gYHRydWVgIGFuZCBgY21kYCBpcyBhIGBDb21tYW5kYCBvciBgQ29tbWFuZE1hcGAsIGl0IHdpbGxcblx0ICogY2xvbmUgdGhlIGBDb21tYW5kYCBpbnN0ZWFkIG9mIHNldCBieSByZWZlcmVuY2UuXG5cdCAqIEByZXR1cm5zIHtBcnJheS48Q29tbWFuZD59XG5cdCAqIEBhY2Nlc3MgcHVibGljXG5cdCAqL1xuXHRhZGQoY21kLCBwYXJhbXMsIGNsb25lKSB7XG5cdFx0aWYgKCFjbWQpIHtcblx0XHRcdHRocm93IEUuSU5WQUxJRF9BUkdVTUVOVCgnSW52YWxpZCBjb21tYW5kJywgeyBuYW1lOiAnY21kJywgc2NvcGU6ICdDb21tYW5kTWFwLmFkZCcsIHZhbHVlOiBjbWQgfSk7XG5cdFx0fVxuXG5cdFx0aWYgKCFDb21tYW5kKSB7XG5cdFx0XHRDb21tYW5kID0gcmVxdWlyZSgnLi9jb21tYW5kJykuZGVmYXVsdDtcblx0XHR9XG5cblx0XHRpZiAocGFyYW1zICE9PSB1bmRlZmluZWQgJiYgcGFyYW1zICE9PSBudWxsKSB7XG5cdFx0XHRpZiAodHlwZW9mIGNtZCAhPT0gJ3N0cmluZycpIHtcblx0XHRcdFx0dGhyb3cgRS5JTlZBTElEX0FSR1VNRU5UKCdDb21tYW5kIHBhcmFtZXRlcnMgYXJlIG9ubHkgYWxsb3dlZCB3aGVuIGNvbW1hbmQgaXMgYSBzdHJpbmcnLCB7IG5hbWU6ICdjbWQnLCBzY29wZTogJ0NvbW1hbmRNYXAuYWRkJywgdmFsdWU6IHsgY21kLCBwYXJhbXMgfSB9KTtcblx0XHRcdH0gZWxzZSBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ2Z1bmN0aW9uJykge1xuXHRcdFx0XHRwYXJhbXMgPSB7IGFjdGlvbjogcGFyYW1zIH07XG5cdFx0XHR9IGVsc2UgaWYgKHR5cGVvZiBwYXJhbXMgIT09ICdvYmplY3QnKSB7XG5cdFx0XHRcdHRocm93IEUuSU5WQUxJRF9BUkdVTUVOVCgnRXhwZWN0ZWQgY29tbWFuZCBwYXJhbWV0ZXJzIHRvIGJlIGFuIG9iamVjdCBvciBmdW5jdGlvbicsIHsgbmFtZTogJ3BhcmFtcycsIHNjb3BlOiAnQ29tbWFuZE1hcC5hZGQnLCB2YWx1ZTogeyBjbWQsIHBhcmFtcyB9IH0pO1xuXHRcdFx0fVxuXHRcdFx0Y21kID0gbmV3IENvbW1hbmQoY21kLCBwYXJhbXMpO1xuXHRcdH1cblxuXHRcdGNvbnN0IHJlc3VsdHMgPSBbXTtcblx0XHRjb25zdCBjb21tYW5kcyA9IHR5cGVvZiBjbWQgPT09ICdvYmplY3QnICYmIGNtZC5jbGlraXQgaW5zdGFuY2VvZiBTZXQgJiYgKGNtZC5jbGlraXQuaGFzKCdDb21tYW5kTGlzdCcpIHx8IGNtZC5jbGlraXQuaGFzKCdDb21tYW5kTWFwJykpID9cblx0XHRcdGNtZC52YWx1ZXMoKSA6XG5cdFx0XHRBcnJheS5pc0FycmF5KGNtZCkgPyBjbWQgOiBbIGNtZCBdO1xuXG5cdFx0Zm9yIChsZXQgaXQgb2YgY29tbWFuZHMpIHtcblx0XHRcdGNtZCA9IG51bGw7XG5cblx0XHRcdGlmICghY2xvbmUgJiYgaXQgaW5zdGFuY2VvZiBDb21tYW5kKSB7XG5cdFx0XHRcdGNtZCA9IGl0O1xuXHRcdFx0fSBlbHNlIGlmICh0eXBlb2YgaXQgPT09ICdzdHJpbmcnKSB7XG5cdFx0XHRcdC8vIHBhdGhcblx0XHRcdFx0aXQgPSBwYXRoLnJlc29sdmUoaXQpO1xuXG5cdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0Y29uc3QgZmlsZXMgPSBmcy5zdGF0U3luYyhpdCkuaXNEaXJlY3RvcnkoKSA/IGZzLnJlYWRkaXJTeW5jKGl0KS5tYXAoZmlsZW5hbWUgPT4gcGF0aC5qb2luKGl0LCBmaWxlbmFtZSkpIDogWyBpdCBdO1xuXHRcdFx0XHRcdGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xuXHRcdFx0XHRcdFx0aWYgKGpzUmVnRXhwLnRlc3QoZmlsZSkpIHtcblx0XHRcdFx0XHRcdFx0Y21kID0gbmV3IENvbW1hbmQoZmlsZSk7XG5cdFx0XHRcdFx0XHRcdHRoaXMuc2V0KGNtZC5uYW1lLCBjbWQpO1xuXHRcdFx0XHRcdFx0XHRyZXN1bHRzLnB1c2goY21kKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0gY2F0Y2ggKGUpIHtcblx0XHRcdFx0XHRpZiAoZS5jb2RlID09PSAnRU5PRU5UJykge1xuXHRcdFx0XHRcdFx0dGhyb3cgRS5GSUxFX05PVF9GT1VORChgQ29tbWFuZCBwYXRoIGRvZXMgbm90IGV4aXN0OiAke2l0fWAsIHsgbmFtZTogJ2NvbW1hbmQnLCBzY29wZTogJ0NvbW1hbmRNYXAuYWRkJywgdmFsdWU6IGl0IH0pO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHR0aHJvdyBlO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0Y29udGludWU7XG5cblx0XHRcdH0gZWxzZSBpZiAoaXQgJiYgdHlwZW9mIGl0ID09PSAnb2JqZWN0Jykge1xuXHRcdFx0XHQvLyBjdG9yIHBhcmFtcyBvciBDb21tYW5kLWxpa2Vcblx0XHRcdFx0aWYgKGl0LmNsaWtpdCBpbnN0YW5jZW9mIFNldCkge1xuXHRcdFx0XHRcdGlmIChpdC5jbGlraXQuaGFzKCdFeHRlbnNpb24nKSkge1xuXHRcdFx0XHRcdFx0Ly8gYWN0aW9ucyBhbmQgZXh0ZW5zaW9ucyBub3Qgc3VwcG9ydGVkIGhlcmVcblx0XHRcdFx0XHRcdGNvbnRpbnVlO1xuXHRcdFx0XHRcdH0gZWxzZSBpZiAoaXQuY2xpa2l0LmhhcygnQ29tbWFuZCcpKSB7XG5cdFx0XHRcdFx0XHRjbWQgPSBuZXcgQ29tbWFuZChpdC5uYW1lLCBpdCk7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdHRocm93IEUuSU5WQUxJRF9DT01NQU5EKGBJbnZhbGlkIGNvbW1hbmQ6IGNsaS1raXQgdHlwZSBcIiR7QXJyYXkuZnJvbShpdC5jbGlraXQpWzBdfVwiIG5vdCBzdXBwb3J0ZWRgLCB7IG5hbWU6ICdjb21tYW5kJywgc2NvcGU6ICdDb21tYW5kTWFwLmFkZCcsIHZhbHVlOiBpdCB9KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0gZWxzZSBpZiAoaXQubmFtZSAmJiB0eXBlb2YgaXQubmFtZSA9PT0gJ3N0cmluZycpIHtcblx0XHRcdFx0XHQvLyB0aGUgb2JqZWN0IGlzIGNvbW1hbmQgY3RvciBwYXJhbXNcblx0XHRcdFx0XHRjbWQgPSBuZXcgQ29tbWFuZChpdC5uYW1lLCBpdCk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0Ly8gYW4gb2JqZWN0IG9mIGNvbW1hbmQgbmFtZXMgdG8gYSBwYXRoLCBjdG9yIHBhcmFtcywgQ29tbWFuZCBvYmplY3QsIG9yIENvbW1hbmQtbGlrZSBvYmplY3RcblxuXHRcdFx0XHRcdGZvciAoY29uc3QgWyBuYW1lLCB2YWx1ZSBdIG9mIE9iamVjdC5lbnRyaWVzKGl0KSkge1xuXHRcdFx0XHRcdFx0Y21kID0gbmV3IENvbW1hbmQobmFtZSwgdmFsdWUpO1xuXHRcdFx0XHRcdFx0dGhpcy5zZXQoY21kLm5hbWUsIGNtZCk7XG5cdFx0XHRcdFx0XHRyZXN1bHRzLnB1c2goY21kKTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRjb250aW51ZTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHRpZiAoY21kIGluc3RhbmNlb2YgQ29tbWFuZCkge1xuXHRcdFx0XHR0aGlzLnNldChjbWQubmFtZSwgY21kKTtcblx0XHRcdFx0cmVzdWx0cy5wdXNoKGNtZCk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0aHJvdyBFLklOVkFMSURfQVJHVU1FTlQoYEludmFsaWQgY29tbWFuZCBcIiR7aXR9XCIsIGV4cGVjdGVkIGFuIG9iamVjdGAsIHsgbmFtZTogJ2NvbW1hbmQnLCBzY29wZTogJ0NvbW1hbmRNYXAuYWRkJywgdmFsdWU6IGl0IH0pO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiByZXN1bHRzO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgdGhlIG51bWJlciBvZiBjb21tYW5kcy5cblx0ICpcblx0ICogQHJldHVybnMge051bWJlcn1cblx0ICogQGFjY2VzcyBwdWJsaWNcblx0ICovXG5cdGdldCBjb3VudCgpIHtcblx0XHRyZXR1cm4gdGhpcy5zaXplO1xuXHR9XG5cblx0LyoqXG5cdCAqIEdlbmVyYXRlcyBhbiBvYmplY3QgY29udGFpbmluZyB0aGUgY29tbWFuZHMgZm9yIHRoZSBoZWxwIHNjcmVlbi5cblx0ICpcblx0ICogQHJldHVybnMge09iamVjdH1cblx0ICogQGFjY2VzcyBwdWJsaWNcblx0ICovXG5cdGdlbmVyYXRlSGVscCgpIHtcblx0XHRjb25zdCBlbnRyaWVzID0gW107XG5cblx0XHRmb3IgKGNvbnN0IGNtZCBvZiBBcnJheS5mcm9tKHRoaXMua2V5cygpKSkge1xuXHRcdFx0Y29uc3QgeyBhbGlhc2VzLCBjbGlraXRIZWxwLCBkZXNjLCBoaWRkZW4sIG5hbWUgfSA9IHRoaXMuZ2V0KGNtZCk7XG5cdFx0XHRpZiAoIWhpZGRlbiAmJiAhY2xpa2l0SGVscCkge1xuXHRcdFx0XHRjb25zdCBsYWJlbHMgPSBuZXcgU2V0KFsgbmFtZSBdKTtcblxuXHRcdFx0XHRmb3IgKGNvbnN0IFsgYWxpYXMsIGRpc3BsYXkgXSBvZiBPYmplY3QuZW50cmllcyhhbGlhc2VzKSkge1xuXHRcdFx0XHRcdGlmIChkaXNwbGF5ID09PSAndmlzaWJsZScpIHtcblx0XHRcdFx0XHRcdGxhYmVscy5hZGQoYWxpYXMpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXG5cdFx0XHRcdGVudHJpZXMucHVzaCh7XG5cdFx0XHRcdFx0bmFtZSxcblx0XHRcdFx0XHRkZXNjLFxuXHRcdFx0XHRcdGxhYmVsOiBBcnJheS5mcm9tKGxhYmVscykuc29ydCgoYSwgYikgPT4ge1xuXHRcdFx0XHRcdFx0cmV0dXJuIGEubGVuZ3RoID09PSBiLmxlbmd0aCA/IGEubG9jYWxlQ29tcGFyZShiKSA6IGEubGVuZ3RoIC0gYi5sZW5ndGg7XG5cdFx0XHRcdFx0fSkuam9pbignLCAnKSxcblx0XHRcdFx0XHRhbGlhc2VzOiBhbGlhc2VzID8gT2JqZWN0LmtleXMoYWxpYXNlcykgOiBudWxsXG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGVudHJpZXMuc29ydCgoYSwgYikgPT4gYS5sYWJlbC5sb2NhbGVDb21wYXJlKGIubGFiZWwpKTtcblxuXHRcdHJldHVybiB7XG5cdFx0XHRjb3VudDogZW50cmllcy5sZW5ndGgsXG5cdFx0XHRlbnRyaWVzXG5cdFx0fTtcblx0fVxufVxuIl0sImZpbGUiOiJwYXJzZXIvY29tbWFuZC1tYXAuanMifQ==
