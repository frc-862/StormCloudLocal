"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _context = _interopRequireDefault(require("./context"));

var _debug = _interopRequireDefault(require("../lib/debug"));

var _errors = _interopRequireDefault(require("../lib/errors"));

var _fs = _interopRequireDefault(require("fs"));

var _help = _interopRequireDefault(require("../commands/help"));

var _path = _interopRequireDefault(require("path"));

var _util = require("../lib/util");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const {
  log
} = (0, _debug.default)('cli-kit:command');
const {
  highlight
} = _debug.default.styles;
const formatRegExp = /^([@! ]*[\w-_]+(?:\s*,\s*[@! ]*[\w-_]+)*)((?:\s*[<[]~?[\w-_]+[>\]])*)?$/;
const nameRegExp = /^([@! ]*)([\w-_]+)\s*$/;
/**
 * Defines a command and its options and arguments.
 *
 * @extends {Context}
 */

class Command extends _context.default {
  /**
   * Internal object for tracking aliases.
   *
   * @type {Object}
   * @private
   */

  /**
   * Custom help header and footer content.
   *
   * @type {Object}
   * @access private
   */

  /**
   * Constructs a command instance.
   *
   * @param {String} name - The command name or absolute path to a file.
   * @param {Object|CLI|Command|Context|Function} [params] - Command parameters or an action
   * function.
   * @param {Function|Command} [params.action] - A function to call when the command is found.
   * @param {Set.<String>|Array.<String>|String|Object} [params.aliases] - An array of command
   * aliases.
   * @param {Function} [params.callback] - A function to call when the command has been parsed.
   * @param {String|Function} [params.defaultCommand] - The default command to execute when this
   * command has no `action`. When value is a `String`, it looks up the subcommand and calls it.
   * If value is a `Function`, it simply invokes it.
   * @param {Boolean} [params.hidden=false] - When `true`, the option is not displayed on the
   * help screen or auto-suggest.
   * @access public
   *
   * @example
   *   new Command('foo')
   *   new Command('foo', {})
   *   new Command(new Command('foo'))
   */
  constructor(name, params = {}) {
    if (name && typeof name === 'string' && _path.default.isAbsolute(name) && _fs.default.existsSync(name)) {
      let ctx;

      try {
        log(`Requiring ${highlight(name)}`);
        ctx = require(name);

        if (!ctx || typeof ctx !== 'object') {
          throw new Error('Command must export an object');
        } // if this is an ES6 module, grab the default export


        if (ctx.__esModule) {
          ctx = ctx.default;
        }

        if (!ctx || typeof ctx !== 'object') {
          throw new Error('Command must export an object');
        }

        name = ctx.name || _path.default.parse(name).name;
        params = ctx;
      } catch (err) {
        throw _errors.default.INVALID_COMMAND(`Bad command "${name}": ${err.message}`, {
          name: name,
          scope: 'Command.constructor',
          value: err
        });
      }
    }

    if (!name || typeof name !== 'string') {
      throw _errors.default.INVALID_ARGUMENT('Expected command name to be a non-empty string', {
        name: 'name',
        scope: 'Command.constructor',
        value: name
      });
    } // parse the name and create the aliases and args: "ls, list <bar>"


    const format = name.trim();
    const m = format.match(formatRegExp);

    if (!m || !m[1]) {
      throw _errors.default.INVALID_ARGUMENT('Expected command name to be a non-empty string', {
        name: 'name',
        scope: 'Command.constructor',
        value: name
      });
    }

    if (typeof params === 'function') {
      params = {
        action: params
      };
    } // reset the name


    name = null; // get the aliases from the format and find the command name

    const aliases = new Set();

    for (let alias of m[1].split(',')) {
      const n = alias.match(nameRegExp);

      if (!n) {
        throw _errors.default.INVALID_ARGUMENT('Invalid command alias format', {
          name: 'alias',
          scope: 'Command.constructor',
          value: alias
        });
      }

      if (!n[1].includes('@') && !name) {
        name = n[2];
      } else {
        aliases.add(n[1].includes('!') ? `!${n[2]}` : n[2]);
      }
    }

    if (!name) {
      throw _errors.default.INVALID_ARGUMENT('Expected command name format to contain at least one non-aliased name', {
        name: 'format',
        scope: 'Command.constructor',
        value: format
      });
    }

    if (!params || typeof params !== 'object' || Array.isArray(params)) {
      throw _errors.default.INVALID_ARGUMENT('Expected command parameters to be an object', {
        name: 'params',
        scope: 'Command.constructor',
        value: params
      });
    }

    if (params.callback && typeof params.callback !== 'function') {
      throw _errors.default.INVALID_ARGUMENT('Expected command callback to be a function', {
        name: 'callback',
        scop: 'Command.constructor',
        value: params.callback
      });
    }

    if (params.defaultCommand !== undefined && (!params.defaultCommand || typeof params.defaultCommand !== 'string' && typeof params.defaultCommand !== 'function')) {
      throw _errors.default.INVALID_ARGUMENT('Expected default command to be a string or function', {
        name: 'defaultCommand',
        scope: 'Command.constructor',
        value: params.defaultCommand
      });
    }

    if (params.clikit instanceof Set) {
      // params is a cli-kit object
      if (params.clikit.has('CLI')) {
        // since a command cannot have a title "global" (only a `CLI` object can have that),
        // we must delete it so that the title is reset to the command name
        if (params.title === 'Global') {
          delete params.title;
        }

        delete params.terminal; // add an action handler that eitehr executes a specific command or the help for
        // for this command (e.g. this command is an extension)

        params.action = async parser => {
          const {
            defaultCommand
          } = params;

          if (defaultCommand === 'help' && this.get('help')) {
            await _help.default.action(parser);
          } else {
            const cmd = defaultCommand && this.commands[defaultCommand];

            if (cmd) {
              return cmd.action.call(cmd, parser);
            }
          }
        };
      } else if (!params.clikit.has('Command')) {
        // must be a command or extension
        throw _errors.default.INVALID_CLIKIT_OBJECT('Expected command options to be a CLI or Command object', {
          name: 'clikit',
          scope: 'Command.constructor',
          value: params.clikit
        });
      }
    }

    if (params.action && typeof params.action !== 'function' && !(params.action instanceof Command)) {
      throw _errors.default.INVALID_ARGUMENT('Expected command action to be a function or Command instance', {
        name: 'action',
        scope: 'Command.constructor',
        value: params.action
      });
    }

    params.name = name;
    const args = m[2] && m[2].trim().split(/\s+/);

    if (args !== null && args !== void 0 && args.length) {
      params.args = params.args ? [...args, ...params.args] : args;
    }

    super(params);

    _defineProperty(this, "_aliases", {});

    _defineProperty(this, "_help", {});

    (0, _util.declareCLIKitClass)(this, 'Command');

    if (params.action) {
      this.action = params.action;
    } else if (typeof params.defaultCommand === 'function') {
      this.action = params.defaultCommand;
    } else if (typeof params.defaultCommand === 'string') {
      this.action = this.lookup.commands[params.defaultCommand];
    } // mix aliases Set with params.aliases


    this._aliases = this.createAliases(aliases, params.aliases);
    this.callback = params.callback;
    this.clikitHelp = params.clikitHelp;
    this.help = params.help || {};
    this.defaultCommand = params.defaultCommand;
    this.hidden = !!params.hidden; // mix in any other custom props

    for (const [key, value] of Object.entries(params)) {
      if (!Object.prototype.hasOwnProperty.call(this, key)) {
        this[key] = value;
      }
    }
  }
  /**
   * A map of aliases an whether they are visible.
   *
   * @type {Object}
   * @access public
   */


  get aliases() {
    return this._aliases;
  }

  set aliases(value) {
    this._aliases = this.createAliases(value);
  }
  /**
   * Merges multiple alias constructs into a single alias object.
   *
   * @param {...Set.<String>|Array.<String>|String|Object} values - One or more alias values.
   * @returns {Object}
   * @access private
   */


  createAliases(...values) {
    const result = {};

    for (let value of values) {
      if (!value) {
        continue;
      }

      if (value instanceof Set) {
        value = Array.from(value);
      }

      if (typeof value === 'object' && !Array.isArray(value)) {
        Object.assign(result, value);
        continue;
      }

      if (!Array.isArray(value)) {
        value = [value];
      }

      for (const alias of value) {
        if (!alias || typeof alias !== 'string') {
          throw _errors.default.INVALID_ARGUMENT('Expected command aliases to be an array of strings', {
            name: 'aliases.alias',
            scope: 'Command.constructor',
            value: alias
          });
        }

        for (const a of alias.split(/[ ,|]+/)) {
          if (a === '!') {
            throw _errors.default.INVALID_ALIAS(`Invalid command alias "${alias}"`, {
              name: 'aliases',
              scope: 'Command.constructor',
              value: alias
            });
          }

          if (a[0] === '!') {
            result[a.substring(1)] = 'hidden';
          } else {
            result[a] = 'visible';
          }
        }
      }
    }

    return result;
  }
  /**
   * Custom help header and footer content. A string, function, or object with `header` and
   * `footer` properties may be used to set the `help` property, but the internal value will
   * always be an object with `header` and `footer` properties.
   *
   * @type {Object}
   * @access public
   */


  get help() {
    return this._help;
  }

  set help(value) {
    if (typeof value === 'string' || typeof value === 'function') {
      this._help.header = value;
    } else if (typeof value === 'object') {
      if (value.header) {
        if (typeof value.header === 'string' || typeof value.header === 'function') {
          this._help.header = value.header;
        } else {
          throw _errors.default.INVALID_ARGUMENT('Expected help content header to be a string or function');
        }
      }

      if (value.footer) {
        if (typeof value.footer === 'string' || typeof value.footer === 'function') {
          this._help.footer = value.footer;
        } else {
          throw _errors.default.INVALID_ARGUMENT('Expected help content footer to be a string or function');
        }
      }
    } else {
      this._help = {};
    }
  }
  /**
   * Returns the schema for this command and all child contexts.
   *
   * @returns {Object}
   * @access public
   */


  schema() {
    return {
      desc: this.desc
    };
  }

}

exports.default = Command;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhcnNlci9jb21tYW5kLmpzIl0sIm5hbWVzIjpbImxvZyIsImhpZ2hsaWdodCIsImRlYnVnIiwic3R5bGVzIiwiZm9ybWF0UmVnRXhwIiwibmFtZVJlZ0V4cCIsIkNvbW1hbmQiLCJDb250ZXh0IiwiY29uc3RydWN0b3IiLCJuYW1lIiwicGFyYW1zIiwicGF0aCIsImlzQWJzb2x1dGUiLCJmcyIsImV4aXN0c1N5bmMiLCJjdHgiLCJyZXF1aXJlIiwiRXJyb3IiLCJfX2VzTW9kdWxlIiwiZGVmYXVsdCIsInBhcnNlIiwiZXJyIiwiRSIsIklOVkFMSURfQ09NTUFORCIsIm1lc3NhZ2UiLCJzY29wZSIsInZhbHVlIiwiSU5WQUxJRF9BUkdVTUVOVCIsImZvcm1hdCIsInRyaW0iLCJtIiwibWF0Y2giLCJhY3Rpb24iLCJhbGlhc2VzIiwiU2V0IiwiYWxpYXMiLCJzcGxpdCIsIm4iLCJpbmNsdWRlcyIsImFkZCIsIkFycmF5IiwiaXNBcnJheSIsImNhbGxiYWNrIiwic2NvcCIsImRlZmF1bHRDb21tYW5kIiwidW5kZWZpbmVkIiwiY2xpa2l0IiwiaGFzIiwidGl0bGUiLCJ0ZXJtaW5hbCIsInBhcnNlciIsImdldCIsImhlbHBDb21tYW5kIiwiY21kIiwiY29tbWFuZHMiLCJjYWxsIiwiSU5WQUxJRF9DTElLSVRfT0JKRUNUIiwiYXJncyIsImxlbmd0aCIsImxvb2t1cCIsIl9hbGlhc2VzIiwiY3JlYXRlQWxpYXNlcyIsImNsaWtpdEhlbHAiLCJoZWxwIiwiaGlkZGVuIiwia2V5IiwiT2JqZWN0IiwiZW50cmllcyIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwidmFsdWVzIiwicmVzdWx0IiwiZnJvbSIsImFzc2lnbiIsImEiLCJJTlZBTElEX0FMSUFTIiwic3Vic3RyaW5nIiwiX2hlbHAiLCJoZWFkZXIiLCJmb290ZXIiLCJzY2hlbWEiLCJkZXNjIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FB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QUExQjtBQUNBLFNBRkQsTUFFTztBQUNOLGdCQUFNeEQsZ0JBQUVLLGdCQUFGLENBQW1CLHlEQUFuQixDQUFOO0FBQ0E7QUFDRDs7QUFDRCxVQUFJRCxLQUFLLENBQUNxRCxNQUFWLEVBQWtCO0FBQ2pCLFlBQUksT0FBT3JELEtBQUssQ0FBQ3FELE1BQWIsS0FBd0IsUUFBeEIsSUFBb0MsT0FBT3JELEtBQUssQ0FBQ3FELE1BQWIsS0FBd0IsVUFBaEUsRUFBNEU7QUFDM0UsZUFBS0YsS0FBTCxDQUFXRSxNQUFYLEdBQW9CckQsS0FBSyxDQUFDcUQsTUFBMUI7QUFDQSxTQUZELE1BRU87QUFDTixnQkFBTXpELGdCQUFFSyxnQkFBRixDQUFtQix5REFBbkIsQ0FBTjtBQUNBO0FBQ0Q7QUFDRCxLQWZNLE1BZUE7QUFDTixXQUFLa0QsS0FBTCxHQUFhLEVBQWI7QUFDQTtBQUNEO0FBRUQ7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFDQ0csRUFBQUEsTUFBTSxHQUFHO0FBQ1IsV0FBTztBQUNOQyxNQUFBQSxJQUFJLEVBQUUsS0FBS0E7QUFETCxLQUFQO0FBR0E7O0FBalMyQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBDb250ZXh0IGZyb20gJy4vY29udGV4dCc7XG5pbXBvcnQgZGVidWcgZnJvbSAnLi4vbGliL2RlYnVnJztcbmltcG9ydCBFIGZyb20gJy4uL2xpYi9lcnJvcnMnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBoZWxwQ29tbWFuZCBmcm9tICcuLi9jb21tYW5kcy9oZWxwJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgeyBkZWNsYXJlQ0xJS2l0Q2xhc3MgfSBmcm9tICcuLi9saWIvdXRpbCc7XG5cbmNvbnN0IHsgbG9nIH0gPSBkZWJ1ZygnY2xpLWtpdDpjb21tYW5kJyk7XG5jb25zdCB7IGhpZ2hsaWdodCB9ID0gZGVidWcuc3R5bGVzO1xuXG5jb25zdCBmb3JtYXRSZWdFeHAgPSAvXihbQCEgXSpbXFx3LV9dKyg/OlxccyosXFxzKltAISBdKltcXHctX10rKSopKCg/OlxccypbPFtdfj9bXFx3LV9dK1s+XFxdXSkqKT8kLztcbmNvbnN0IG5hbWVSZWdFeHAgPSAvXihbQCEgXSopKFtcXHctX10rKVxccyokLztcblxuLyoqXG4gKiBEZWZpbmVzIGEgY29tbWFuZCBhbmQgaXRzIG9wdGlvbnMgYW5kIGFyZ3VtZW50cy5cbiAqXG4gKiBAZXh0ZW5kcyB7Q29udGV4dH1cbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ29tbWFuZCBleHRlbmRzIENvbnRleHQge1xuXHQvKipcblx0ICogSW50ZXJuYWwgb2JqZWN0IGZvciB0cmFja2luZyBhbGlhc2VzLlxuXHQgKlxuXHQgKiBAdHlwZSB7T2JqZWN0fVxuXHQgKiBAcHJpdmF0ZVxuXHQgKi9cblx0X2FsaWFzZXMgPSB7fTtcblxuXHQvKipcblx0ICogQ3VzdG9tIGhlbHAgaGVhZGVyIGFuZCBmb290ZXIgY29udGVudC5cblx0ICpcblx0ICogQHR5cGUge09iamVjdH1cblx0ICogQGFjY2VzcyBwcml2YXRlXG5cdCAqL1xuXHRfaGVscCA9IHt9O1xuXG5cdC8qKlxuXHQgKiBDb25zdHJ1Y3RzIGEgY29tbWFuZCBpbnN0YW5jZS5cblx0ICpcblx0ICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgLSBUaGUgY29tbWFuZCBuYW1lIG9yIGFic29sdXRlIHBhdGggdG8gYSBmaWxlLlxuXHQgKiBAcGFyYW0ge09iamVjdHxDTEl8Q29tbWFuZHxDb250ZXh0fEZ1bmN0aW9ufSBbcGFyYW1zXSAtIENvbW1hbmQgcGFyYW1ldGVycyBvciBhbiBhY3Rpb25cblx0ICogZnVuY3Rpb24uXG5cdCAqIEBwYXJhbSB7RnVuY3Rpb258Q29tbWFuZH0gW3BhcmFtcy5hY3Rpb25dIC0gQSBmdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhlIGNvbW1hbmQgaXMgZm91bmQuXG5cdCAqIEBwYXJhbSB7U2V0LjxTdHJpbmc+fEFycmF5LjxTdHJpbmc+fFN0cmluZ3xPYmplY3R9IFtwYXJhbXMuYWxpYXNlc10gLSBBbiBhcnJheSBvZiBjb21tYW5kXG5cdCAqIGFsaWFzZXMuXG5cdCAqIEBwYXJhbSB7RnVuY3Rpb259IFtwYXJhbXMuY2FsbGJhY2tdIC0gQSBmdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhlIGNvbW1hbmQgaGFzIGJlZW4gcGFyc2VkLlxuXHQgKiBAcGFyYW0ge1N0cmluZ3xGdW5jdGlvbn0gW3BhcmFtcy5kZWZhdWx0Q29tbWFuZF0gLSBUaGUgZGVmYXVsdCBjb21tYW5kIHRvIGV4ZWN1dGUgd2hlbiB0aGlzXG5cdCAqIGNvbW1hbmQgaGFzIG5vIGBhY3Rpb25gLiBXaGVuIHZhbHVlIGlzIGEgYFN0cmluZ2AsIGl0IGxvb2tzIHVwIHRoZSBzdWJjb21tYW5kIGFuZCBjYWxscyBpdC5cblx0ICogSWYgdmFsdWUgaXMgYSBgRnVuY3Rpb25gLCBpdCBzaW1wbHkgaW52b2tlcyBpdC5cblx0ICogQHBhcmFtIHtCb29sZWFufSBbcGFyYW1zLmhpZGRlbj1mYWxzZV0gLSBXaGVuIGB0cnVlYCwgdGhlIG9wdGlvbiBpcyBub3QgZGlzcGxheWVkIG9uIHRoZVxuXHQgKiBoZWxwIHNjcmVlbiBvciBhdXRvLXN1Z2dlc3QuXG5cdCAqIEBhY2Nlc3MgcHVibGljXG5cdCAqXG5cdCAqIEBleGFtcGxlXG5cdCAqICAgbmV3IENvbW1hbmQoJ2ZvbycpXG5cdCAqICAgbmV3IENvbW1hbmQoJ2ZvbycsIHt9KVxuXHQgKiAgIG5ldyBDb21tYW5kKG5ldyBDb21tYW5kKCdmb28nKSlcblx0ICovXG5cdGNvbnN0cnVjdG9yKG5hbWUsIHBhcmFtcyA9IHt9KSB7XG5cdFx0aWYgKG5hbWUgJiYgdHlwZW9mIG5hbWUgPT09ICdzdHJpbmcnICYmIHBhdGguaXNBYnNvbHV0ZShuYW1lKSAmJiBmcy5leGlzdHNTeW5jKG5hbWUpKSB7XG5cdFx0XHRsZXQgY3R4O1xuXHRcdFx0dHJ5IHtcblx0XHRcdFx0bG9nKGBSZXF1aXJpbmcgJHtoaWdobGlnaHQobmFtZSl9YCk7XG5cdFx0XHRcdGN0eCA9IHJlcXVpcmUobmFtZSk7XG5cdFx0XHRcdGlmICghY3R4IHx8IHR5cGVvZiBjdHggIT09ICdvYmplY3QnKSB7XG5cdFx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKCdDb21tYW5kIG11c3QgZXhwb3J0IGFuIG9iamVjdCcpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0Ly8gaWYgdGhpcyBpcyBhbiBFUzYgbW9kdWxlLCBncmFiIHRoZSBkZWZhdWx0IGV4cG9ydFxuXHRcdFx0XHRpZiAoY3R4Ll9fZXNNb2R1bGUpIHtcblx0XHRcdFx0XHRjdHggPSBjdHguZGVmYXVsdDtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGlmICghY3R4IHx8IHR5cGVvZiBjdHggIT09ICdvYmplY3QnKSB7XG5cdFx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKCdDb21tYW5kIG11c3QgZXhwb3J0IGFuIG9iamVjdCcpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0bmFtZSA9IGN0eC5uYW1lIHx8IHBhdGgucGFyc2UobmFtZSkubmFtZTtcblx0XHRcdFx0cGFyYW1zID0gY3R4O1xuXHRcdFx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0XHRcdHRocm93IEUuSU5WQUxJRF9DT01NQU5EKGBCYWQgY29tbWFuZCBcIiR7bmFtZX1cIjogJHtlcnIubWVzc2FnZX1gLCB7IG5hbWU6IG5hbWUsIHNjb3BlOiAnQ29tbWFuZC5jb25zdHJ1Y3RvcicsIHZhbHVlOiBlcnIgfSk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0aWYgKCFuYW1lIHx8IHR5cGVvZiBuYW1lICE9PSAnc3RyaW5nJykge1xuXHRcdFx0dGhyb3cgRS5JTlZBTElEX0FSR1VNRU5UKCdFeHBlY3RlZCBjb21tYW5kIG5hbWUgdG8gYmUgYSBub24tZW1wdHkgc3RyaW5nJywgeyBuYW1lOiAnbmFtZScsIHNjb3BlOiAnQ29tbWFuZC5jb25zdHJ1Y3RvcicsIHZhbHVlOiBuYW1lIH0pO1xuXHRcdH1cblxuXHRcdC8vIHBhcnNlIHRoZSBuYW1lIGFuZCBjcmVhdGUgdGhlIGFsaWFzZXMgYW5kIGFyZ3M6IFwibHMsIGxpc3QgPGJhcj5cIlxuXHRcdGNvbnN0IGZvcm1hdCA9IG5hbWUudHJpbSgpO1xuXHRcdGNvbnN0IG0gPSBmb3JtYXQubWF0Y2goZm9ybWF0UmVnRXhwKTtcblx0XHRpZiAoIW0gfHwgIW1bMV0pIHtcblx0XHRcdHRocm93IEUuSU5WQUxJRF9BUkdVTUVOVCgnRXhwZWN0ZWQgY29tbWFuZCBuYW1lIHRvIGJlIGEgbm9uLWVtcHR5IHN0cmluZycsIHsgbmFtZTogJ25hbWUnLCBzY29wZTogJ0NvbW1hbmQuY29uc3RydWN0b3InLCB2YWx1ZTogbmFtZSB9KTtcblx0XHR9XG5cblx0XHRpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ2Z1bmN0aW9uJykge1xuXHRcdFx0cGFyYW1zID0geyBhY3Rpb246IHBhcmFtcyB9O1xuXHRcdH1cblxuXHRcdC8vIHJlc2V0IHRoZSBuYW1lXG5cdFx0bmFtZSA9IG51bGw7XG5cblx0XHQvLyBnZXQgdGhlIGFsaWFzZXMgZnJvbSB0aGUgZm9ybWF0IGFuZCBmaW5kIHRoZSBjb21tYW5kIG5hbWVcblx0XHRjb25zdCBhbGlhc2VzID0gbmV3IFNldCgpO1xuXHRcdGZvciAobGV0IGFsaWFzIG9mIG1bMV0uc3BsaXQoJywnKSkge1xuXHRcdFx0Y29uc3QgbiA9IGFsaWFzLm1hdGNoKG5hbWVSZWdFeHApO1xuXHRcdFx0aWYgKCFuKSB7XG5cdFx0XHRcdHRocm93IEUuSU5WQUxJRF9BUkdVTUVOVCgnSW52YWxpZCBjb21tYW5kIGFsaWFzIGZvcm1hdCcsIHsgbmFtZTogJ2FsaWFzJywgc2NvcGU6ICdDb21tYW5kLmNvbnN0cnVjdG9yJywgdmFsdWU6IGFsaWFzIH0pO1xuXHRcdFx0fVxuXHRcdFx0aWYgKCFuWzFdLmluY2x1ZGVzKCdAJykgJiYgIW5hbWUpIHtcblx0XHRcdFx0bmFtZSA9IG5bMl07XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRhbGlhc2VzLmFkZChuWzFdLmluY2x1ZGVzKCchJykgPyBgISR7blsyXX1gIDogblsyXSk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0aWYgKCFuYW1lKSB7XG5cdFx0XHR0aHJvdyAgRS5JTlZBTElEX0FSR1VNRU5UKCdFeHBlY3RlZCBjb21tYW5kIG5hbWUgZm9ybWF0IHRvIGNvbnRhaW4gYXQgbGVhc3Qgb25lIG5vbi1hbGlhc2VkIG5hbWUnLCB7IG5hbWU6ICdmb3JtYXQnLCBzY29wZTogJ0NvbW1hbmQuY29uc3RydWN0b3InLCB2YWx1ZTogZm9ybWF0IH0pO1xuXHRcdH1cblxuXHRcdGlmICghcGFyYW1zIHx8ICh0eXBlb2YgcGFyYW1zICE9PSAnb2JqZWN0JyB8fCBBcnJheS5pc0FycmF5KHBhcmFtcykpKSB7XG5cdFx0XHR0aHJvdyBFLklOVkFMSURfQVJHVU1FTlQoJ0V4cGVjdGVkIGNvbW1hbmQgcGFyYW1ldGVycyB0byBiZSBhbiBvYmplY3QnLCB7IG5hbWU6ICdwYXJhbXMnLCBzY29wZTogJ0NvbW1hbmQuY29uc3RydWN0b3InLCB2YWx1ZTogcGFyYW1zIH0pO1xuXHRcdH1cblxuXHRcdGlmIChwYXJhbXMuY2FsbGJhY2sgJiYgdHlwZW9mIHBhcmFtcy5jYWxsYmFjayAhPT0gJ2Z1bmN0aW9uJykge1xuXHRcdFx0dGhyb3cgRS5JTlZBTElEX0FSR1VNRU5UKCdFeHBlY3RlZCBjb21tYW5kIGNhbGxiYWNrIHRvIGJlIGEgZnVuY3Rpb24nLCB7IG5hbWU6ICdjYWxsYmFjaycsIHNjb3A6ICdDb21tYW5kLmNvbnN0cnVjdG9yJywgdmFsdWU6IHBhcmFtcy5jYWxsYmFjayB9KTtcblx0XHR9XG5cblx0XHRpZiAocGFyYW1zLmRlZmF1bHRDb21tYW5kICE9PSB1bmRlZmluZWQgJiYgKCFwYXJhbXMuZGVmYXVsdENvbW1hbmQgfHwgKHR5cGVvZiBwYXJhbXMuZGVmYXVsdENvbW1hbmQgIT09ICdzdHJpbmcnICYmIHR5cGVvZiBwYXJhbXMuZGVmYXVsdENvbW1hbmQgIT09ICdmdW5jdGlvbicpKSkge1xuXHRcdFx0dGhyb3cgRS5JTlZBTElEX0FSR1VNRU5UKCdFeHBlY3RlZCBkZWZhdWx0IGNvbW1hbmQgdG8gYmUgYSBzdHJpbmcgb3IgZnVuY3Rpb24nLCB7IG5hbWU6ICdkZWZhdWx0Q29tbWFuZCcsIHNjb3BlOiAnQ29tbWFuZC5jb25zdHJ1Y3RvcicsIHZhbHVlOiBwYXJhbXMuZGVmYXVsdENvbW1hbmQgfSk7XG5cdFx0fVxuXG5cdFx0aWYgKHBhcmFtcy5jbGlraXQgaW5zdGFuY2VvZiBTZXQpIHtcblx0XHRcdC8vIHBhcmFtcyBpcyBhIGNsaS1raXQgb2JqZWN0XG5cdFx0XHRpZiAocGFyYW1zLmNsaWtpdC5oYXMoJ0NMSScpKSB7XG5cdFx0XHRcdC8vIHNpbmNlIGEgY29tbWFuZCBjYW5ub3QgaGF2ZSBhIHRpdGxlIFwiZ2xvYmFsXCIgKG9ubHkgYSBgQ0xJYCBvYmplY3QgY2FuIGhhdmUgdGhhdCksXG5cdFx0XHRcdC8vIHdlIG11c3QgZGVsZXRlIGl0IHNvIHRoYXQgdGhlIHRpdGxlIGlzIHJlc2V0IHRvIHRoZSBjb21tYW5kIG5hbWVcblx0XHRcdFx0aWYgKHBhcmFtcy50aXRsZSA9PT0gJ0dsb2JhbCcpIHtcblx0XHRcdFx0XHRkZWxldGUgcGFyYW1zLnRpdGxlO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0ZGVsZXRlIHBhcmFtcy50ZXJtaW5hbDtcblxuXHRcdFx0XHQvLyBhZGQgYW4gYWN0aW9uIGhhbmRsZXIgdGhhdCBlaXRlaHIgZXhlY3V0ZXMgYSBzcGVjaWZpYyBjb21tYW5kIG9yIHRoZSBoZWxwIGZvclxuXHRcdFx0XHQvLyBmb3IgdGhpcyBjb21tYW5kIChlLmcuIHRoaXMgY29tbWFuZCBpcyBhbiBleHRlbnNpb24pXG5cdFx0XHRcdHBhcmFtcy5hY3Rpb24gPSBhc3luYyBwYXJzZXIgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IHsgZGVmYXVsdENvbW1hbmQgfSA9IHBhcmFtcztcblx0XHRcdFx0XHRpZiAoZGVmYXVsdENvbW1hbmQgPT09ICdoZWxwJyAmJiB0aGlzLmdldCgnaGVscCcpKSB7XG5cdFx0XHRcdFx0XHRhd2FpdCBoZWxwQ29tbWFuZC5hY3Rpb24ocGFyc2VyKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0Y29uc3QgY21kID0gZGVmYXVsdENvbW1hbmQgJiYgdGhpcy5jb21tYW5kc1tkZWZhdWx0Q29tbWFuZF07XG5cdFx0XHRcdFx0XHRpZiAoY21kKSB7XG5cdFx0XHRcdFx0XHRcdHJldHVybiBjbWQuYWN0aW9uLmNhbGwoY21kLCBwYXJzZXIpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0fTtcblx0XHRcdH0gZWxzZSBpZiAoIXBhcmFtcy5jbGlraXQuaGFzKCdDb21tYW5kJykpIHtcblx0XHRcdFx0Ly8gbXVzdCBiZSBhIGNvbW1hbmQgb3IgZXh0ZW5zaW9uXG5cdFx0XHRcdHRocm93IEUuSU5WQUxJRF9DTElLSVRfT0JKRUNUKCdFeHBlY3RlZCBjb21tYW5kIG9wdGlvbnMgdG8gYmUgYSBDTEkgb3IgQ29tbWFuZCBvYmplY3QnLCB7IG5hbWU6ICdjbGlraXQnLCBzY29wZTogJ0NvbW1hbmQuY29uc3RydWN0b3InLCB2YWx1ZTogcGFyYW1zLmNsaWtpdCB9KTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRpZiAocGFyYW1zLmFjdGlvbiAmJiB0eXBlb2YgcGFyYW1zLmFjdGlvbiAhPT0gJ2Z1bmN0aW9uJyAmJiAhKHBhcmFtcy5hY3Rpb24gaW5zdGFuY2VvZiBDb21tYW5kKSkge1xuXHRcdFx0dGhyb3cgRS5JTlZBTElEX0FSR1VNRU5UKCdFeHBlY3RlZCBjb21tYW5kIGFjdGlvbiB0byBiZSBhIGZ1bmN0aW9uIG9yIENvbW1hbmQgaW5zdGFuY2UnLCB7IG5hbWU6ICdhY3Rpb24nLCBzY29wZTogJ0NvbW1hbmQuY29uc3RydWN0b3InLCB2YWx1ZTogcGFyYW1zLmFjdGlvbiB9KTtcblx0XHR9XG5cblx0XHRwYXJhbXMubmFtZSA9IG5hbWU7XG5cblx0XHRjb25zdCBhcmdzID0gbVsyXSAmJiBtWzJdLnRyaW0oKS5zcGxpdCgvXFxzKy8pO1xuXHRcdGlmIChhcmdzPy5sZW5ndGgpIHtcblx0XHRcdHBhcmFtcy5hcmdzID0gcGFyYW1zLmFyZ3MgPyBbIC4uLmFyZ3MsIC4uLnBhcmFtcy5hcmdzIF0gOiBhcmdzO1xuXHRcdH1cblxuXHRcdHN1cGVyKHBhcmFtcyk7XG5cdFx0ZGVjbGFyZUNMSUtpdENsYXNzKHRoaXMsICdDb21tYW5kJyk7XG5cblx0XHRpZiAocGFyYW1zLmFjdGlvbikge1xuXHRcdFx0dGhpcy5hY3Rpb24gPSBwYXJhbXMuYWN0aW9uO1xuXHRcdH0gZWxzZSBpZiAodHlwZW9mIHBhcmFtcy5kZWZhdWx0Q29tbWFuZCA9PT0gJ2Z1bmN0aW9uJykge1xuXHRcdFx0dGhpcy5hY3Rpb24gPSBwYXJhbXMuZGVmYXVsdENvbW1hbmQ7XG5cdFx0fSBlbHNlIGlmICh0eXBlb2YgcGFyYW1zLmRlZmF1bHRDb21tYW5kID09PSAnc3RyaW5nJykge1xuXHRcdFx0dGhpcy5hY3Rpb24gPSB0aGlzLmxvb2t1cC5jb21tYW5kc1twYXJhbXMuZGVmYXVsdENvbW1hbmRdO1xuXHRcdH1cblxuXHRcdC8vIG1peCBhbGlhc2VzIFNldCB3aXRoIHBhcmFtcy5hbGlhc2VzXG5cdFx0dGhpcy5fYWxpYXNlcyAgICAgICA9IHRoaXMuY3JlYXRlQWxpYXNlcyhhbGlhc2VzLCBwYXJhbXMuYWxpYXNlcyk7XG5cdFx0dGhpcy5jYWxsYmFjayAgICAgICA9IHBhcmFtcy5jYWxsYmFjaztcblx0XHR0aGlzLmNsaWtpdEhlbHAgICAgID0gcGFyYW1zLmNsaWtpdEhlbHA7XG5cdFx0dGhpcy5oZWxwICAgICAgICAgICA9IHBhcmFtcy5oZWxwIHx8IHt9O1xuXHRcdHRoaXMuZGVmYXVsdENvbW1hbmQgPSBwYXJhbXMuZGVmYXVsdENvbW1hbmQ7XG5cdFx0dGhpcy5oaWRkZW4gICAgICAgICA9ICEhcGFyYW1zLmhpZGRlbjtcblxuXHRcdC8vIG1peCBpbiBhbnkgb3RoZXIgY3VzdG9tIHByb3BzXG5cdFx0Zm9yIChjb25zdCBbIGtleSwgdmFsdWUgXSBvZiBPYmplY3QuZW50cmllcyhwYXJhbXMpKSB7XG5cdFx0XHRpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLCBrZXkpKSB7XG5cdFx0XHRcdHRoaXNba2V5XSA9IHZhbHVlO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBBIG1hcCBvZiBhbGlhc2VzIGFuIHdoZXRoZXIgdGhleSBhcmUgdmlzaWJsZS5cblx0ICpcblx0ICogQHR5cGUge09iamVjdH1cblx0ICogQGFjY2VzcyBwdWJsaWNcblx0ICovXG5cdGdldCBhbGlhc2VzKCkge1xuXHRcdHJldHVybiB0aGlzLl9hbGlhc2VzO1xuXHR9XG5cblx0c2V0IGFsaWFzZXModmFsdWUpIHtcblx0XHR0aGlzLl9hbGlhc2VzID0gdGhpcy5jcmVhdGVBbGlhc2VzKHZhbHVlKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBNZXJnZXMgbXVsdGlwbGUgYWxpYXMgY29uc3RydWN0cyBpbnRvIGEgc2luZ2xlIGFsaWFzIG9iamVjdC5cblx0ICpcblx0ICogQHBhcmFtIHsuLi5TZXQuPFN0cmluZz58QXJyYXkuPFN0cmluZz58U3RyaW5nfE9iamVjdH0gdmFsdWVzIC0gT25lIG9yIG1vcmUgYWxpYXMgdmFsdWVzLlxuXHQgKiBAcmV0dXJucyB7T2JqZWN0fVxuXHQgKiBAYWNjZXNzIHByaXZhdGVcblx0ICovXG5cdGNyZWF0ZUFsaWFzZXMoLi4udmFsdWVzKSB7XG5cdFx0Y29uc3QgcmVzdWx0ID0ge307XG5cblx0XHRmb3IgKGxldCB2YWx1ZSBvZiB2YWx1ZXMpIHtcblx0XHRcdGlmICghdmFsdWUpIHtcblx0XHRcdFx0Y29udGludWU7XG5cdFx0XHR9XG5cblx0XHRcdGlmICh2YWx1ZSBpbnN0YW5jZW9mIFNldCkge1xuXHRcdFx0XHR2YWx1ZSA9IEFycmF5LmZyb20odmFsdWUpO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiAhQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcblx0XHRcdFx0T2JqZWN0LmFzc2lnbihyZXN1bHQsIHZhbHVlKTtcblx0XHRcdFx0Y29udGludWU7XG5cdFx0XHR9XG5cblx0XHRcdGlmICghQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcblx0XHRcdFx0dmFsdWUgPSBbIHZhbHVlIF07XG5cdFx0XHR9XG5cblx0XHRcdGZvciAoY29uc3QgYWxpYXMgb2YgdmFsdWUpIHtcblx0XHRcdFx0aWYgKCFhbGlhcyB8fCB0eXBlb2YgYWxpYXMgIT09ICdzdHJpbmcnKSB7XG5cdFx0XHRcdFx0dGhyb3cgRS5JTlZBTElEX0FSR1VNRU5UKCdFeHBlY3RlZCBjb21tYW5kIGFsaWFzZXMgdG8gYmUgYW4gYXJyYXkgb2Ygc3RyaW5ncycsIHsgbmFtZTogJ2FsaWFzZXMuYWxpYXMnLCBzY29wZTogJ0NvbW1hbmQuY29uc3RydWN0b3InLCB2YWx1ZTogYWxpYXMgfSk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRmb3IgKGNvbnN0IGEgb2YgYWxpYXMuc3BsaXQoL1sgLHxdKy8pKSB7XG5cdFx0XHRcdFx0aWYgKGEgPT09ICchJykge1xuXHRcdFx0XHRcdFx0dGhyb3cgRS5JTlZBTElEX0FMSUFTKGBJbnZhbGlkIGNvbW1hbmQgYWxpYXMgXCIke2FsaWFzfVwiYCwgeyBuYW1lOiAnYWxpYXNlcycsIHNjb3BlOiAnQ29tbWFuZC5jb25zdHJ1Y3RvcicsIHZhbHVlOiBhbGlhcyB9KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0aWYgKGFbMF0gPT09ICchJykge1xuXHRcdFx0XHRcdFx0cmVzdWx0W2Euc3Vic3RyaW5nKDEpXSA9ICdoaWRkZW4nO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRyZXN1bHRbYV0gPSAndmlzaWJsZSc7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHJlc3VsdDtcblx0fVxuXG5cdC8qKlxuXHQgKiBDdXN0b20gaGVscCBoZWFkZXIgYW5kIGZvb3RlciBjb250ZW50LiBBIHN0cmluZywgZnVuY3Rpb24sIG9yIG9iamVjdCB3aXRoIGBoZWFkZXJgIGFuZFxuXHQgKiBgZm9vdGVyYCBwcm9wZXJ0aWVzIG1heSBiZSB1c2VkIHRvIHNldCB0aGUgYGhlbHBgIHByb3BlcnR5LCBidXQgdGhlIGludGVybmFsIHZhbHVlIHdpbGxcblx0ICogYWx3YXlzIGJlIGFuIG9iamVjdCB3aXRoIGBoZWFkZXJgIGFuZCBgZm9vdGVyYCBwcm9wZXJ0aWVzLlxuXHQgKlxuXHQgKiBAdHlwZSB7T2JqZWN0fVxuXHQgKiBAYWNjZXNzIHB1YmxpY1xuXHQgKi9cblx0Z2V0IGhlbHAoKSB7XG5cdFx0cmV0dXJuIHRoaXMuX2hlbHA7XG5cdH1cblxuXHRzZXQgaGVscCh2YWx1ZSkge1xuXHRcdGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJykge1xuXHRcdFx0dGhpcy5faGVscC5oZWFkZXIgPSB2YWx1ZTtcblx0XHR9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcpIHtcblx0XHRcdGlmICh2YWx1ZS5oZWFkZXIpIHtcblx0XHRcdFx0aWYgKHR5cGVvZiB2YWx1ZS5oZWFkZXIgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiB2YWx1ZS5oZWFkZXIgPT09ICdmdW5jdGlvbicpIHtcblx0XHRcdFx0XHR0aGlzLl9oZWxwLmhlYWRlciA9IHZhbHVlLmhlYWRlcjtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHR0aHJvdyBFLklOVkFMSURfQVJHVU1FTlQoJ0V4cGVjdGVkIGhlbHAgY29udGVudCBoZWFkZXIgdG8gYmUgYSBzdHJpbmcgb3IgZnVuY3Rpb24nKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdFx0aWYgKHZhbHVlLmZvb3Rlcikge1xuXHRcdFx0XHRpZiAodHlwZW9mIHZhbHVlLmZvb3RlciA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIHZhbHVlLmZvb3RlciA9PT0gJ2Z1bmN0aW9uJykge1xuXHRcdFx0XHRcdHRoaXMuX2hlbHAuZm9vdGVyID0gdmFsdWUuZm9vdGVyO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHRocm93IEUuSU5WQUxJRF9BUkdVTUVOVCgnRXhwZWN0ZWQgaGVscCBjb250ZW50IGZvb3RlciB0byBiZSBhIHN0cmluZyBvciBmdW5jdGlvbicpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRoaXMuX2hlbHAgPSB7fTtcblx0XHR9XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyB0aGUgc2NoZW1hIGZvciB0aGlzIGNvbW1hbmQgYW5kIGFsbCBjaGlsZCBjb250ZXh0cy5cblx0ICpcblx0ICogQHJldHVybnMge09iamVjdH1cblx0ICogQGFjY2VzcyBwdWJsaWNcblx0ICovXG5cdHNjaGVtYSgpIHtcblx0XHRyZXR1cm4ge1xuXHRcdFx0ZGVzYzogdGhpcy5kZXNjXG5cdFx0fTtcblx0fVxufVxuIl0sImZpbGUiOiJwYXJzZXIvY29tbWFuZC5qcyJ9
