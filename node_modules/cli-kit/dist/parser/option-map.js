"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _errors = _interopRequireDefault(require("../lib/errors"));

var _option = _interopRequireDefault(require("./option"));

var _util = require("../lib/util");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * Stores a map of `Option` instances that have been registered for a context.
 *
 * @extends {Map}
 */
class OptionMap extends Map {
  /**
   * An internal counter of options that have been added.
   *
   * @type {Number}
   */

  /**
   * Declares the class name.
   *
   * @access public
   */
  constructor() {
    super();

    _defineProperty(this, "count", 0);

    (0, _util.declareCLIKitClass)(this, 'OptionList');
  }
  /**
   * Adds a option to the list.
   *
   * @param {String|Object|Option|OptionMap|Array<Object|Option|String>} format - An option
   * format, an object of format to option descriptions, `Option` constructor params or `Option`
   * instances, an `Option` instance, an `OptionMap` instance, or an array of `Option`
   * constructor params and `Option` instances grouped by `String` labels.
   * @param {Object|Option|String} [params] - When `format` is a format string, then this
   * argument is either `Option` constructor parameters, an `Option` instance, or an option
   * description.
   * @returns {Array.<Option>}
   * @access public
   */


  add(format, params) {
    if (!format) {
      throw _errors.default.INVALID_ARGUMENT('Invalid option format or option', {
        name: 'format',
        scope: 'OptionMap.add',
        value: format
      });
    }

    const results = [];
    let lastGroup = '';
    let options = [];

    if (Array.isArray(format)) {
      options = format;
    } else if (typeof format === 'object' && format.clikit instanceof Set && (format.clikit.has('OptionList') || format.clikit.has('OptionMap'))) {
      for (const [group, opts] of format.entries()) {
        if (group && group !== lastGroup) {
          options.push(group);
          lastGroup = group;
        }

        options.push.apply(options, opts);
      }
    } else if (typeof format === 'object' && (format instanceof _option.default || !(format.clikit instanceof Set) || !format.clikit.has('Option'))) {
      options.push(format);
    } else {
      options.push(new _option.default(format, params));
    } // reset group


    lastGroup = '';

    const add = opt => {
      let opts = this.get(lastGroup);

      if (!opts) {
        this.set(lastGroup, opts = []);
      }

      opts.push(opt);
      results.push(opt);
      this.count++;
    }; // at this point we have a unified array of stuff


    for (const it of options) {
      if (typeof it === 'string') {
        lastGroup = it;
        continue;
      }

      if (typeof it !== 'object') {
        throw _errors.default.INVALID_ARGUMENT(`Expected option to be an object: ${it && it.name || it}`, {
          name: 'option',
          scope: 'OptionMap.add',
          value: it
        });
      }

      if (it instanceof _option.default) {
        add(it);
      } else if (it.clikit instanceof Set) {
        add(new _option.default(it));
      } else {
        // it is a format-params object
        for (const [format, params] of Object.entries(it)) {
          add(params instanceof _option.default ? params : new _option.default(format, params));
        }
      }
    }

    return results;
  }
  /**
   * Generates an object containing the options for the help screen.
   *
   * @returns {Object}
   * @access public
   */


  generateHelp() {
    let count = 0;
    const groups = {};

    const sortFn = (a, b) => {
      return a.order < b.order ? -1 : a.order > b.order ? 1 : a.long.localeCompare(b.long);
    };

    for (const [groupName, options] of this.entries()) {
      const group = groups[groupName] = [];

      for (const opt of options.sort(sortFn)) {
        if (!opt.hidden) {
          const label = `${opt.short ? `-${opt.short}, ` : ''}` + `--${opt.negate ? 'no-' : ''}${opt.long}` + `${opt.isFlag ? '' : ` ${opt.required ? '<' : '['}${opt.hint || 'value'}${opt.required ? '>' : ']'}`}`;
          group.push({
            aliases: Object.keys(opt.aliases).filter(a => opt.aliases[a]),
            datatype: opt.datatype,
            default: opt.default,
            desc: opt.desc,
            hint: opt.hint,
            isFlag: opt.isFlag,
            label,
            long: opt.long,
            max: opt.max,
            min: opt.min,
            name: opt.name,
            negate: opt.negate,
            required: opt.required,
            short: opt.short
          });
          count++;
        }
      }
    }

    return {
      count,
      groups
    };
  }

}

exports.default = OptionMap;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhcnNlci9vcHRpb24tbWFwLmpzIl0sIm5hbWVzIjpbIk9wdGlvbk1hcCIsIk1hcCIsImNvbnN0cnVjdG9yIiwiYWRkIiwiZm9ybWF0IiwicGFyYW1zIiwiRSIsIklOVkFMSURfQVJHVU1FTlQiLCJuYW1lIiwic2NvcGUiLCJ2YWx1ZSIsInJlc3VsdHMiLCJsYXN0R3JvdXAiLCJvcHRpb25zIiwiQXJyYXkiLCJpc0FycmF5IiwiY2xpa2l0IiwiU2V0IiwiaGFzIiwiZ3JvdXAiLCJvcHRzIiwiZW50cmllcyIsInB1c2giLCJhcHBseSIsIk9wdGlvbiIsIm9wdCIsImdldCIsInNldCIsImNvdW50IiwiaXQiLCJPYmplY3QiLCJnZW5lcmF0ZUhlbHAiLCJncm91cHMiLCJzb3J0Rm4iLCJhIiwiYiIsIm9yZGVyIiwibG9uZyIsImxvY2FsZUNvbXBhcmUiLCJncm91cE5hbWUiLCJzb3J0IiwiaGlkZGVuIiwibGFiZWwiLCJzaG9ydCIsIm5lZ2F0ZSIsImlzRmxhZyIsInJlcXVpcmVkIiwiaGludCIsImFsaWFzZXMiLCJrZXlzIiwiZmlsdGVyIiwiZGF0YXR5cGUiLCJkZWZhdWx0IiwiZGVzYyIsIm1heCIsIm1pbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUVBOzs7Ozs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ2UsTUFBTUEsU0FBTixTQUF3QkMsR0FBeEIsQ0FBNEI7QUFDMUM7QUFDRDtBQUNBO0FBQ0E7QUFDQTs7QUFHQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0NDLEVBQUFBLFdBQVcsR0FBRztBQUNiOztBQURhLG1DQVBOLENBT007O0FBRWIsa0NBQW1CLElBQW5CLEVBQXlCLFlBQXpCO0FBQ0E7QUFFRDtBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FBQ0NDLEVBQUFBLEdBQUcsQ0FBQ0MsTUFBRCxFQUFTQyxNQUFULEVBQWlCO0FBQ25CLFFBQUksQ0FBQ0Qs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SUFSSjtBQVNWaUIsWUFBQUEsR0FBRyxFQUFPN0IsR0FBRyxDQUFDNkIsR0FUSjtBQVVWQyxZQUFBQSxHQUFHLEVBQU85QixHQUFHLENBQUM4QixHQVZKO0FBV1YvQyxZQUFBQSxJQUFJLEVBQU1pQixHQUFHLENBQUNqQixJQVhKO0FBWVZvQyxZQUFBQSxNQUFNLEVBQUluQixHQUFHLENBQUNtQixNQVpKO0FBYVZFLFlBQUFBLFFBQVEsRUFBRXJCLEdBQUcsQ0FBQ3FCLFFBYko7QUFjVkgsWUFBQUEsS0FBSyxFQUFLbEIsR0FBRyxDQUFDa0I7QUFkSixXQUFYO0FBZ0JBZixVQUFBQSxLQUFLO0FBQ0w7QUFDRDtBQUNEOztBQUVELFdBQU87QUFDTkEsTUFBQUEsS0FETTtBQUVOSSxNQUFBQTtBQUZNLEtBQVA7QUFJQTs7QUE3SXlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEUgZnJvbSAnLi4vbGliL2Vycm9ycyc7XG5pbXBvcnQgT3B0aW9uIGZyb20gJy4vb3B0aW9uJztcblxuaW1wb3J0IHsgZGVjbGFyZUNMSUtpdENsYXNzIH0gZnJvbSAnLi4vbGliL3V0aWwnO1xuXG4vKipcbiAqIFN0b3JlcyBhIG1hcCBvZiBgT3B0aW9uYCBpbnN0YW5jZXMgdGhhdCBoYXZlIGJlZW4gcmVnaXN0ZXJlZCBmb3IgYSBjb250ZXh0LlxuICpcbiAqIEBleHRlbmRzIHtNYXB9XG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9wdGlvbk1hcCBleHRlbmRzIE1hcCB7XG5cdC8qKlxuXHQgKiBBbiBpbnRlcm5hbCBjb3VudGVyIG9mIG9wdGlvbnMgdGhhdCBoYXZlIGJlZW4gYWRkZWQuXG5cdCAqXG5cdCAqIEB0eXBlIHtOdW1iZXJ9XG5cdCAqL1xuXHRjb3VudCA9IDA7XG5cblx0LyoqXG5cdCAqIERlY2xhcmVzIHRoZSBjbGFzcyBuYW1lLlxuXHQgKlxuXHQgKiBAYWNjZXNzIHB1YmxpY1xuXHQgKi9cblx0Y29uc3RydWN0b3IoKSB7XG5cdFx0c3VwZXIoKTtcblx0XHRkZWNsYXJlQ0xJS2l0Q2xhc3ModGhpcywgJ09wdGlvbkxpc3QnKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBBZGRzIGEgb3B0aW9uIHRvIHRoZSBsaXN0LlxuXHQgKlxuXHQgKiBAcGFyYW0ge1N0cmluZ3xPYmplY3R8T3B0aW9ufE9wdGlvbk1hcHxBcnJheTxPYmplY3R8T3B0aW9ufFN0cmluZz59IGZvcm1hdCAtIEFuIG9wdGlvblxuXHQgKiBmb3JtYXQsIGFuIG9iamVjdCBvZiBmb3JtYXQgdG8gb3B0aW9uIGRlc2NyaXB0aW9ucywgYE9wdGlvbmAgY29uc3RydWN0b3IgcGFyYW1zIG9yIGBPcHRpb25gXG5cdCAqIGluc3RhbmNlcywgYW4gYE9wdGlvbmAgaW5zdGFuY2UsIGFuIGBPcHRpb25NYXBgIGluc3RhbmNlLCBvciBhbiBhcnJheSBvZiBgT3B0aW9uYFxuXHQgKiBjb25zdHJ1Y3RvciBwYXJhbXMgYW5kIGBPcHRpb25gIGluc3RhbmNlcyBncm91cGVkIGJ5IGBTdHJpbmdgIGxhYmVscy5cblx0ICogQHBhcmFtIHtPYmplY3R8T3B0aW9ufFN0cmluZ30gW3BhcmFtc10gLSBXaGVuIGBmb3JtYXRgIGlzIGEgZm9ybWF0IHN0cmluZywgdGhlbiB0aGlzXG5cdCAqIGFyZ3VtZW50IGlzIGVpdGhlciBgT3B0aW9uYCBjb25zdHJ1Y3RvciBwYXJhbWV0ZXJzLCBhbiBgT3B0aW9uYCBpbnN0YW5jZSwgb3IgYW4gb3B0aW9uXG5cdCAqIGRlc2NyaXB0aW9uLlxuXHQgKiBAcmV0dXJucyB7QXJyYXkuPE9wdGlvbj59XG5cdCAqIEBhY2Nlc3MgcHVibGljXG5cdCAqL1xuXHRhZGQoZm9ybWF0LCBwYXJhbXMpIHtcblx0XHRpZiAoIWZvcm1hdCkge1xuXHRcdFx0dGhyb3cgRS5JTlZBTElEX0FSR1VNRU5UKCdJbnZhbGlkIG9wdGlvbiBmb3JtYXQgb3Igb3B0aW9uJywgeyBuYW1lOiAnZm9ybWF0Jywgc2NvcGU6ICdPcHRpb25NYXAuYWRkJywgdmFsdWU6IGZvcm1hdCB9KTtcblx0XHR9XG5cblx0XHRjb25zdCByZXN1bHRzID0gW107XG5cdFx0bGV0IGxhc3RHcm91cCA9ICcnO1xuXHRcdGxldCBvcHRpb25zID0gW107XG5cblx0XHRpZiAoQXJyYXkuaXNBcnJheShmb3JtYXQpKSB7XG5cdFx0XHRvcHRpb25zID0gZm9ybWF0O1xuXHRcdH0gZWxzZSBpZiAodHlwZW9mIGZvcm1hdCA9PT0gJ29iamVjdCcgJiYgZm9ybWF0LmNsaWtpdCBpbnN0YW5jZW9mIFNldCAmJiAoZm9ybWF0LmNsaWtpdC5oYXMoJ09wdGlvbkxpc3QnKSB8fCBmb3JtYXQuY2xpa2l0LmhhcygnT3B0aW9uTWFwJykpKSB7XG5cdFx0XHRmb3IgKGNvbnN0IFsgZ3JvdXAsIG9wdHMgXSBvZiBmb3JtYXQuZW50cmllcygpKSB7XG5cdFx0XHRcdGlmIChncm91cCAmJiBncm91cCAhPT0gbGFzdEdyb3VwKSB7XG5cdFx0XHRcdFx0b3B0aW9ucy5wdXNoKGdyb3VwKTtcblx0XHRcdFx0XHRsYXN0R3JvdXAgPSBncm91cDtcblx0XHRcdFx0fVxuXHRcdFx0XHRvcHRpb25zLnB1c2guYXBwbHkob3B0aW9ucywgb3B0cyk7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIGlmICh0eXBlb2YgZm9ybWF0ID09PSAnb2JqZWN0JyAmJiAoZm9ybWF0IGluc3RhbmNlb2YgT3B0aW9uIHx8ICEoZm9ybWF0LmNsaWtpdCBpbnN0YW5jZW9mIFNldCkgfHwgIWZvcm1hdC5jbGlraXQuaGFzKCdPcHRpb24nKSkpIHtcblx0XHRcdG9wdGlvbnMucHVzaChmb3JtYXQpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRvcHRpb25zLnB1c2gobmV3IE9wdGlvbihmb3JtYXQsIHBhcmFtcykpO1xuXHRcdH1cblxuXHRcdC8vIHJlc2V0IGdyb3VwXG5cdFx0bGFzdEdyb3VwID0gJyc7XG5cblx0XHRjb25zdCBhZGQgPSBvcHQgPT4ge1xuXHRcdFx0bGV0IG9wdHMgPSB0aGlzLmdldChsYXN0R3JvdXApO1xuXHRcdFx0aWYgKCFvcHRzKSB7XG5cdFx0XHRcdHRoaXMuc2V0KGxhc3RHcm91cCwgb3B0cyA9IFtdKTtcblx0XHRcdH1cblx0XHRcdG9wdHMucHVzaChvcHQpO1xuXHRcdFx0cmVzdWx0cy5wdXNoKG9wdCk7XG5cdFx0XHR0aGlzLmNvdW50Kys7XG5cdFx0fTtcblxuXHRcdC8vIGF0IHRoaXMgcG9pbnQgd2UgaGF2ZSBhIHVuaWZpZWQgYXJyYXkgb2Ygc3R1ZmZcblx0XHRmb3IgKGNvbnN0IGl0IG9mIG9wdGlvbnMpIHtcblx0XHRcdGlmICh0eXBlb2YgaXQgPT09ICdzdHJpbmcnKSB7XG5cdFx0XHRcdGxhc3RHcm91cCA9IGl0O1xuXHRcdFx0XHRjb250aW51ZTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKHR5cGVvZiBpdCAhPT0gJ29iamVjdCcpIHtcblx0XHRcdFx0dGhyb3cgRS5JTlZBTElEX0FSR1VNRU5UKGBFeHBlY3RlZCBvcHRpb24gdG8gYmUgYW4gb2JqZWN0OiAke2l0ICYmIGl0Lm5hbWUgfHwgaXR9YCwgeyBuYW1lOiAnb3B0aW9uJywgc2NvcGU6ICdPcHRpb25NYXAuYWRkJywgdmFsdWU6IGl0IH0pO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoaXQgaW5zdGFuY2VvZiBPcHRpb24pIHtcblx0XHRcdFx0YWRkKGl0KTtcblx0XHRcdH0gZWxzZSBpZiAoaXQuY2xpa2l0IGluc3RhbmNlb2YgU2V0KSB7XG5cdFx0XHRcdGFkZChuZXcgT3B0aW9uKGl0KSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHQvLyBpdCBpcyBhIGZvcm1hdC1wYXJhbXMgb2JqZWN0XG5cdFx0XHRcdGZvciAoY29uc3QgWyBmb3JtYXQsIHBhcmFtcyBdIG9mIE9iamVjdC5lbnRyaWVzKGl0KSkge1xuXHRcdFx0XHRcdGFkZChwYXJhbXMgaW5zdGFuY2VvZiBPcHRpb24gPyBwYXJhbXMgOiBuZXcgT3B0aW9uKGZvcm1hdCwgcGFyYW1zKSk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gcmVzdWx0cztcblx0fVxuXG5cdC8qKlxuXHQgKiBHZW5lcmF0ZXMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIG9wdGlvbnMgZm9yIHRoZSBoZWxwIHNjcmVlbi5cblx0ICpcblx0ICogQHJldHVybnMge09iamVjdH1cblx0ICogQGFjY2VzcyBwdWJsaWNcblx0ICovXG5cdGdlbmVyYXRlSGVscCgpIHtcblx0XHRsZXQgY291bnQgPSAwO1xuXHRcdGNvbnN0IGdyb3VwcyA9IHt9O1xuXHRcdGNvbnN0IHNvcnRGbiA9IChhLCBiKSA9PiB7XG5cdFx0XHRyZXR1cm4gYS5vcmRlciA8IGIub3JkZXIgPyAtMSA6IGEub3JkZXIgPiBiLm9yZGVyID8gMSA6IGEubG9uZy5sb2NhbGVDb21wYXJlKGIubG9uZyk7XG5cdFx0fTtcblxuXHRcdGZvciAoY29uc3QgWyBncm91cE5hbWUsIG9wdGlvbnMgXSBvZiB0aGlzLmVudHJpZXMoKSkge1xuXHRcdFx0Y29uc3QgZ3JvdXAgPSBncm91cHNbZ3JvdXBOYW1lXSA9IFtdO1xuXHRcdFx0Zm9yIChjb25zdCBvcHQgb2Ygb3B0aW9ucy5zb3J0KHNvcnRGbikpIHtcblx0XHRcdFx0aWYgKCFvcHQuaGlkZGVuKSB7XG5cdFx0XHRcdFx0Y29uc3QgbGFiZWwgPSBgJHtvcHQuc2hvcnQgPyBgLSR7b3B0LnNob3J0fSwgYCA6ICcnfWAgK1xuXHRcdFx0XHRcdFx0YC0tJHtvcHQubmVnYXRlID8gJ25vLScgOiAnJ30ke29wdC5sb25nfWAgK1xuXHRcdFx0XHRcdFx0YCR7b3B0LmlzRmxhZyA/ICcnIDogYCAke29wdC5yZXF1aXJlZCA/ICc8JyA6ICdbJ30ke29wdC5oaW50IHx8ICd2YWx1ZSd9JHtvcHQucmVxdWlyZWQgPyAnPicgOiAnXSd9YH1gO1xuXG5cdFx0XHRcdFx0Z3JvdXAucHVzaCh7XG5cdFx0XHRcdFx0XHRhbGlhc2VzOiAgT2JqZWN0LmtleXMob3B0LmFsaWFzZXMpLmZpbHRlcihhID0+IG9wdC5hbGlhc2VzW2FdKSxcblx0XHRcdFx0XHRcdGRhdGF0eXBlOiBvcHQuZGF0YXR5cGUsXG5cdFx0XHRcdFx0XHRkZWZhdWx0OiAgb3B0LmRlZmF1bHQsXG5cdFx0XHRcdFx0XHRkZXNjOiAgICAgb3B0LmRlc2MsXG5cdFx0XHRcdFx0XHRoaW50OiAgICAgb3B0LmhpbnQsXG5cdFx0XHRcdFx0XHRpc0ZsYWc6ICAgb3B0LmlzRmxhZyxcblx0XHRcdFx0XHRcdGxhYmVsLFxuXHRcdFx0XHRcdFx0bG9uZzogICAgIG9wdC5sb25nLFxuXHRcdFx0XHRcdFx0bWF4OiAgICAgIG9wdC5tYXgsXG5cdFx0XHRcdFx0XHRtaW46ICAgICAgb3B0Lm1pbixcblx0XHRcdFx0XHRcdG5hbWU6ICAgICBvcHQubmFtZSxcblx0XHRcdFx0XHRcdG5lZ2F0ZTogICBvcHQubmVnYXRlLFxuXHRcdFx0XHRcdFx0cmVxdWlyZWQ6IG9wdC5yZXF1aXJlZCxcblx0XHRcdFx0XHRcdHNob3J0OiAgICBvcHQuc2hvcnRcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRjb3VudCsrO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHtcblx0XHRcdGNvdW50LFxuXHRcdFx0Z3JvdXBzXG5cdFx0fTtcblx0fVxufVxuIl0sImZpbGUiOiJwYXJzZXIvb3B0aW9uLW1hcC5qcyJ9
