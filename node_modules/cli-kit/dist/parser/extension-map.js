"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _errors = _interopRequireDefault(require("../lib/errors"));

var _util = require("../lib/util");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let Extension;
/**
 * Stores a map of `Extension` instances that have been registered for a context.
 *
 * @extends {Map}
 */

class ExtensionMap extends Map {
  /**
   * Declares the class name.
   *
   * @access public
   */
  constructor() {
    super();
    (0, _util.declareCLIKitClass)(this, 'ExtensionMap');
  }
  /**
   * Adds an extension to the map.
   *
   * @param {Object|String|Extension|ExtensionMap|Array.<String|Extension>} ext - An object of
   * extension names to extension paths or instances, an extension path, an `Extension` instance,
   * or an array of those types. An extension path may be a directory containing a Node.js
   * module, a path to a `.js` file, or the name of a executable. May also be an `ExtensionMap`
   * instance.
   * @param {String} [name] - The extension name used for the context name. If not set, it will
   * attempt to find a `package.json` with a `cli-kit.name` value.
   * @param {Boolean} [clone] - When `true` and `ext` is an `Extension` or `ExtensionMap`, it
   * will clone the `Extension` instead of set by reference.
   * @returns {Array.<Extension>}
   * @access public
   *
   * @example
   *   .add({ foo: '/path/to/ext', bar: new Extension() })
   *   .add('/path/to/ext');
   *   .add('/path/to/ext', 'foo');
   *   .add(new Extension())
   *   .add(new ExtensionMap())
   *   .add([ '/path/to/ext', new Extension() ])
   */


  add(ext, name, clone) {
    if (!ext) {
      throw _errors.default.INVALID_ARGUMENT('Expected extension to be an extension instance or a path', {
        name: 'ext',
        scope: 'ExtensionMap.add',
        value: ext
      });
    }

    if (name && typeof name !== 'string') {
      throw _errors.default.INVALID_ARGUMENT('Expected extension name to be a string', {
        name: 'name',
        scope: 'ExtensionMap.add',
        value: name
      });
    }

    if (!Extension) {
      Extension = require('./extension').default;
    }

    const results = [];
    const extensions = typeof ext === 'object' ? ext.clikit instanceof Set && ext.clikit.has('Extension') ? [ext] : ext.clikit instanceof Set && ext.clikit.has('ExtensionMap') ? ext.entries() : Object.entries(ext) : Array.isArray(ext) ? ext : [ext]; // at this point, we have an array of `Strings` (paths), Array [name,ext], and Extension instances

    for (let it of extensions) {
      let ext = null;

      if (!clone && it instanceof Extension) {
        ext = it;
      } else if (Array.isArray(it)) {
        // [name,ext]
        const [name, pathOrExt] = it;
        ext = pathOrExt instanceof Extension ? pathOrExt : new Extension(pathOrExt, {
          name
        });
      } else if (it && (typeof it === 'string' || typeof it === 'object' && it.clikit instanceof Set && it.clikit.has('Extension'))) {
        // path or params
        ext = new Extension(it, {
          name
        });
      }

      if (ext) {
        for (const ctxName of Object.keys(ext.exports)) {
          this.set(ctxName, ext);
        }

        results.push(ext);
      } else {
        throw _errors.default.INVALID_ARGUMENT(`Invalid extension "${it}", expected a valid path or an object`, {
          name: 'extension',
          scope: 'ExtensionMap.add',
          value: it
        });
      }
    }

    return results;
  }
  /**
   * Returns the number of extensions.
   *
   * @returns {Number}
   * @access public
   */


  get count() {
    return this.size;
  }
  /**
   * Generates an object containing the extensions for the help screen.
   *
   * @returns {Object}
   * @access public
   */


  generateHelp() {
    const entries = [];

    for (const ctxName of Array.from(this.keys())) {
      const {
        aliases,
        clikitHelp,
        desc,
        hidden,
        name
      } = this.get(ctxName).exports[ctxName];

      if (!hidden && !clikitHelp) {
        const labels = new Set([name]);

        for (const [alias, display] of Object.entries(aliases)) {
          if (display === 'visible') {
            labels.add(alias);
          }
        }

        entries.push({
          name,
          desc,
          label: Array.from(labels).sort((a, b) => {
            return a.length === b.length ? a.localeCompare(b) : a.length - b.length;
          }).join(', '),
          aliases: aliases ? Object.keys(aliases) : null
        });
      }
    }

    entries.sort((a, b) => a.label.localeCompare(b.label));
    return {
      count: entries.length,
      entries
    };
  }

}

exports.default = ExtensionMap;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhcnNlci9leHRlbnNpb24tbWFwLmpzIl0sIm5hbWVzIjpbIkV4dGVuc2lvbiIsIkV4dGVuc2lvbk1hcCIsIk1hcCIsImNvbnN0cnVjdG9yIiwiYWRkIiwiZXh0IiwibmFtZSIsImNsb25lIiwiRSIsIklOVkFMSURfQVJHVU1FTlQiLCJzY29wZSIsInZhbHVlIiwicmVxdWlyZSIsImRlZmF1bHQiLCJyZXN1bHRzIiwiZXh0ZW5zaW9ucyIsImNsaWtpdCIsIlNldCIsImhhcyIsImVudHJpZXMiLCJPYmplY3QiLCJBcnJheSIsImlzQXJyYXkiLCJpdCIsInBhdGhPckV4dCIsImN0eE5hbWUiLCJrZXlzIiwiZXhwb3J0cyIsInNldCIsInB1c2giLCJjb3VudCIsInNpemUiLCJnZW5lcmF0ZUhlbHAiLCJmcm9tIiwiYWxpYXNlcyIsImNsaWtpdEhlbHAiLCJkZXNjIiwiaGlkZGVuIiwiZ2V0IiwibGFiZWxzIiwiYWxpYXMiLCJkaXNwbGF5IiwibGFiZWwiLCJzb3J0IiwiYSIsImIiLCJsZW5ndGgiLCJsb2NhbGVDb21wYXJlIiwiam9pbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUVBOzs7O0FBRUEsSUFBSUEsU0FBSjtBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBQ2UsTUFBTUMsWUFBTixTQUEyQkMsR0FBM0IsQ0FBK0I7QUFDN0M7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNDQyxFQUFBQSxXQUFXLEdBQUc7QUFDYjtBQUNBLGtDQUFtQixJQUFuQixFQUF5QixjQUF6QjtBQUNBO0FBRUQ7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FBQ0NDLEVBQUFBLEdBQUcsQ0FBQ0MsR0FBRCxFQUFNQyxJQUFOLEVBQVlDLEtBQVosRUFBbUI7QUFDckIsUUFBSSxDQUFDRixHQUFMLEVBQVU7QUFDVCxZ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QUFuQixDQUF3QixDQUFDQyxDQUFELEVBQUlDLENBQUosS0FBVTtBQUN4QyxtQkFBT0QsQ0FBQyxDQUFDRSxNQUFGLEtBQWFELENBQUMsQ0FBQ0MsTUFBZixHQUF3QkYsQ0FBQyxDQUFDRyxhQUFGLENBQWdCRixDQUFoQixDQUF4QixHQUE2Q0QsQ0FBQyxDQUFDRSxNQUFGLEdBQVdELENBQUMsQ0FBQ0MsTUFBakU7QUFDQSxXQUZNLEVBRUpFLElBRkksQ0FFQyxJQUZELENBSEs7QUFNWmQsVUFBQUEsT0FBTyxFQUFFQSxPQUFPLEdBQUdkLE1BQU0sQ0FBQ00sSUFBUCxDQUFZUSxPQUFaLENBQUgsR0FBMEI7QUFOOUIsU0FBYjtBQVFBO0FBQ0Q7O0FBRURmLElBQUFBLE9BQU8sQ0FBQ3dCLElBQVIsQ0FBYSxDQUFDQyxDQUFELEVBQUlDLENBQUosS0FBVUQsQ0FBQyxDQUFDRixLQUFGLENBQVFLLGFBQVIsQ0FBc0JGLENBQUMsQ0FBQ0gsS0FBeEIsQ0FBdkI7QUFFQSxXQUFPO0FBQ05aLE1BQUFBLEtBQUssRUFBRVgsT0FBTyxDQUFDMkIsTUFEVDtBQUVOM0IsTUFBQUE7QUFGTSxLQUFQO0FBSUE7O0FBdEk0QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBFIGZyb20gJy4uL2xpYi9lcnJvcnMnO1xuXG5pbXBvcnQgeyBkZWNsYXJlQ0xJS2l0Q2xhc3MgfSBmcm9tICcuLi9saWIvdXRpbCc7XG5cbmxldCBFeHRlbnNpb247XG5cbi8qKlxuICogU3RvcmVzIGEgbWFwIG9mIGBFeHRlbnNpb25gIGluc3RhbmNlcyB0aGF0IGhhdmUgYmVlbiByZWdpc3RlcmVkIGZvciBhIGNvbnRleHQuXG4gKlxuICogQGV4dGVuZHMge01hcH1cbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRXh0ZW5zaW9uTWFwIGV4dGVuZHMgTWFwIHtcblx0LyoqXG5cdCAqIERlY2xhcmVzIHRoZSBjbGFzcyBuYW1lLlxuXHQgKlxuXHQgKiBAYWNjZXNzIHB1YmxpY1xuXHQgKi9cblx0Y29uc3RydWN0b3IoKSB7XG5cdFx0c3VwZXIoKTtcblx0XHRkZWNsYXJlQ0xJS2l0Q2xhc3ModGhpcywgJ0V4dGVuc2lvbk1hcCcpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEFkZHMgYW4gZXh0ZW5zaW9uIHRvIHRoZSBtYXAuXG5cdCAqXG5cdCAqIEBwYXJhbSB7T2JqZWN0fFN0cmluZ3xFeHRlbnNpb258RXh0ZW5zaW9uTWFwfEFycmF5LjxTdHJpbmd8RXh0ZW5zaW9uPn0gZXh0IC0gQW4gb2JqZWN0IG9mXG5cdCAqIGV4dGVuc2lvbiBuYW1lcyB0byBleHRlbnNpb24gcGF0aHMgb3IgaW5zdGFuY2VzLCBhbiBleHRlbnNpb24gcGF0aCwgYW4gYEV4dGVuc2lvbmAgaW5zdGFuY2UsXG5cdCAqIG9yIGFuIGFycmF5IG9mIHRob3NlIHR5cGVzLiBBbiBleHRlbnNpb24gcGF0aCBtYXkgYmUgYSBkaXJlY3RvcnkgY29udGFpbmluZyBhIE5vZGUuanNcblx0ICogbW9kdWxlLCBhIHBhdGggdG8gYSBgLmpzYCBmaWxlLCBvciB0aGUgbmFtZSBvZiBhIGV4ZWN1dGFibGUuIE1heSBhbHNvIGJlIGFuIGBFeHRlbnNpb25NYXBgXG5cdCAqIGluc3RhbmNlLlxuXHQgKiBAcGFyYW0ge1N0cmluZ30gW25hbWVdIC0gVGhlIGV4dGVuc2lvbiBuYW1lIHVzZWQgZm9yIHRoZSBjb250ZXh0IG5hbWUuIElmIG5vdCBzZXQsIGl0IHdpbGxcblx0ICogYXR0ZW1wdCB0byBmaW5kIGEgYHBhY2thZ2UuanNvbmAgd2l0aCBhIGBjbGkta2l0Lm5hbWVgIHZhbHVlLlxuXHQgKiBAcGFyYW0ge0Jvb2xlYW59IFtjbG9uZV0gLSBXaGVuIGB0cnVlYCBhbmQgYGV4dGAgaXMgYW4gYEV4dGVuc2lvbmAgb3IgYEV4dGVuc2lvbk1hcGAsIGl0XG5cdCAqIHdpbGwgY2xvbmUgdGhlIGBFeHRlbnNpb25gIGluc3RlYWQgb2Ygc2V0IGJ5IHJlZmVyZW5jZS5cblx0ICogQHJldHVybnMge0FycmF5LjxFeHRlbnNpb24+fVxuXHQgKiBAYWNjZXNzIHB1YmxpY1xuXHQgKlxuXHQgKiBAZXhhbXBsZVxuXHQgKiAgIC5hZGQoeyBmb286ICcvcGF0aC90by9leHQnLCBiYXI6IG5ldyBFeHRlbnNpb24oKSB9KVxuXHQgKiAgIC5hZGQoJy9wYXRoL3RvL2V4dCcpO1xuXHQgKiAgIC5hZGQoJy9wYXRoL3RvL2V4dCcsICdmb28nKTtcblx0ICogICAuYWRkKG5ldyBFeHRlbnNpb24oKSlcblx0ICogICAuYWRkKG5ldyBFeHRlbnNpb25NYXAoKSlcblx0ICogICAuYWRkKFsgJy9wYXRoL3RvL2V4dCcsIG5ldyBFeHRlbnNpb24oKSBdKVxuXHQgKi9cblx0YWRkKGV4dCwgbmFtZSwgY2xvbmUpIHtcblx0XHRpZiAoIWV4dCkge1xuXHRcdFx0dGhyb3cgRS5JTlZBTElEX0FSR1VNRU5UKCdFeHBlY3RlZCBleHRlbnNpb24gdG8gYmUgYW4gZXh0ZW5zaW9uIGluc3RhbmNlIG9yIGEgcGF0aCcsIHsgbmFtZTogJ2V4dCcsIHNjb3BlOiAnRXh0ZW5zaW9uTWFwLmFkZCcsIHZhbHVlOiBleHQgfSk7XG5cdFx0fVxuXG5cdFx0aWYgKG5hbWUgJiYgdHlwZW9mIG5hbWUgIT09ICdzdHJpbmcnKSB7XG5cdFx0XHR0aHJvdyBFLklOVkFMSURfQVJHVU1FTlQoJ0V4cGVjdGVkIGV4dGVuc2lvbiBuYW1lIHRvIGJlIGEgc3RyaW5nJywgeyBuYW1lOiAnbmFtZScsIHNjb3BlOiAnRXh0ZW5zaW9uTWFwLmFkZCcsIHZhbHVlOiBuYW1lIH0pO1xuXHRcdH1cblxuXHRcdGlmICghRXh0ZW5zaW9uKSB7XG5cdFx0XHRFeHRlbnNpb24gPSByZXF1aXJlKCcuL2V4dGVuc2lvbicpLmRlZmF1bHQ7XG5cdFx0fVxuXG5cdFx0Y29uc3QgcmVzdWx0cyA9IFtdO1xuXHRcdGNvbnN0IGV4dGVuc2lvbnMgPSB0eXBlb2YgZXh0ID09PSAnb2JqZWN0J1xuXHRcdFx0PyAoXG5cdFx0XHRcdGV4dC5jbGlraXQgaW5zdGFuY2VvZiBTZXQgJiYgZXh0LmNsaWtpdC5oYXMoJ0V4dGVuc2lvbicpXG5cdFx0XHRcdFx0PyBbIGV4dCBdXG5cdFx0XHRcdFx0OiBleHQuY2xpa2l0IGluc3RhbmNlb2YgU2V0ICYmIGV4dC5jbGlraXQuaGFzKCdFeHRlbnNpb25NYXAnKVxuXHRcdFx0XHRcdFx0PyBleHQuZW50cmllcygpXG5cdFx0XHRcdFx0XHQ6IE9iamVjdC5lbnRyaWVzKGV4dClcblx0XHRcdClcblx0XHRcdDogQXJyYXkuaXNBcnJheShleHQpID8gZXh0IDogWyBleHQgXTtcblxuXHRcdC8vIGF0IHRoaXMgcG9pbnQsIHdlIGhhdmUgYW4gYXJyYXkgb2YgYFN0cmluZ3NgIChwYXRocyksIEFycmF5IFtuYW1lLGV4dF0sIGFuZCBFeHRlbnNpb24gaW5zdGFuY2VzXG5cblx0XHRmb3IgKGxldCBpdCBvZiBleHRlbnNpb25zKSB7XG5cdFx0XHRsZXQgZXh0ID0gbnVsbDtcblxuXHRcdFx0aWYgKCFjbG9uZSAmJiBpdCBpbnN0YW5jZW9mIEV4dGVuc2lvbikge1xuXHRcdFx0XHRleHQgPSBpdDtcblx0XHRcdH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShpdCkpIHtcblx0XHRcdFx0Ly8gW25hbWUsZXh0XVxuXHRcdFx0XHRjb25zdCBbIG5hbWUsIHBhdGhPckV4dCBdID0gaXQ7XG5cdFx0XHRcdGV4dCA9IHBhdGhPckV4dCBpbnN0YW5jZW9mIEV4dGVuc2lvbiA/IHBhdGhPckV4dCA6IG5ldyBFeHRlbnNpb24ocGF0aE9yRXh0LCB7IG5hbWUgfSk7XG5cdFx0XHR9IGVsc2UgaWYgKGl0ICYmICh0eXBlb2YgaXQgPT09ICdzdHJpbmcnIHx8ICh0eXBlb2YgaXQgPT09ICdvYmplY3QnICYmIGl0LmNsaWtpdCBpbnN0YW5jZW9mIFNldCAmJiBpdC5jbGlraXQuaGFzKCdFeHRlbnNpb24nKSkpKSB7XG5cdFx0XHRcdC8vIHBhdGggb3IgcGFyYW1zXG5cdFx0XHRcdGV4dCA9IG5ldyBFeHRlbnNpb24oaXQsIHsgbmFtZSB9KTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKGV4dCkge1xuXHRcdFx0XHRmb3IgKGNvbnN0IGN0eE5hbWUgb2YgT2JqZWN0LmtleXMoZXh0LmV4cG9ydHMpKSB7XG5cdFx0XHRcdFx0dGhpcy5zZXQoY3R4TmFtZSwgZXh0KTtcblx0XHRcdFx0fVxuXHRcdFx0XHRyZXN1bHRzLnB1c2goZXh0KTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHRocm93IEUuSU5WQUxJRF9BUkdVTUVOVChgSW52YWxpZCBleHRlbnNpb24gXCIke2l0fVwiLCBleHBlY3RlZCBhIHZhbGlkIHBhdGggb3IgYW4gb2JqZWN0YCwgeyBuYW1lOiAnZXh0ZW5zaW9uJywgc2NvcGU6ICdFeHRlbnNpb25NYXAuYWRkJywgdmFsdWU6IGl0IH0pO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiByZXN1bHRzO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgdGhlIG51bWJlciBvZiBleHRlbnNpb25zLlxuXHQgKlxuXHQgKiBAcmV0dXJucyB7TnVtYmVyfVxuXHQgKiBAYWNjZXNzIHB1YmxpY1xuXHQgKi9cblx0Z2V0IGNvdW50KCkge1xuXHRcdHJldHVybiB0aGlzLnNpemU7XG5cdH1cblxuXHQvKipcblx0ICogR2VuZXJhdGVzIGFuIG9iamVjdCBjb250YWluaW5nIHRoZSBleHRlbnNpb25zIGZvciB0aGUgaGVscCBzY3JlZW4uXG5cdCAqXG5cdCAqIEByZXR1cm5zIHtPYmplY3R9XG5cdCAqIEBhY2Nlc3MgcHVibGljXG5cdCAqL1xuXHRnZW5lcmF0ZUhlbHAoKSB7XG5cdFx0Y29uc3QgZW50cmllcyA9IFtdO1xuXG5cdFx0Zm9yIChjb25zdCBjdHhOYW1lIG9mIEFycmF5LmZyb20odGhpcy5rZXlzKCkpKSB7XG5cdFx0XHRjb25zdCB7IGFsaWFzZXMsIGNsaWtpdEhlbHAsIGRlc2MsIGhpZGRlbiwgbmFtZSB9ID0gdGhpcy5nZXQoY3R4TmFtZSkuZXhwb3J0c1tjdHhOYW1lXTtcblx0XHRcdGlmICghaGlkZGVuICYmICFjbGlraXRIZWxwKSB7XG5cdFx0XHRcdGNvbnN0IGxhYmVscyA9IG5ldyBTZXQoWyBuYW1lIF0pO1xuXG5cdFx0XHRcdGZvciAoY29uc3QgWyBhbGlhcywgZGlzcGxheSBdIG9mIE9iamVjdC5lbnRyaWVzKGFsaWFzZXMpKSB7XG5cdFx0XHRcdFx0aWYgKGRpc3BsYXkgPT09ICd2aXNpYmxlJykge1xuXHRcdFx0XHRcdFx0bGFiZWxzLmFkZChhbGlhcyk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cblx0XHRcdFx0ZW50cmllcy5wdXNoKHtcblx0XHRcdFx0XHRuYW1lLFxuXHRcdFx0XHRcdGRlc2MsXG5cdFx0XHRcdFx0bGFiZWw6IEFycmF5LmZyb20obGFiZWxzKS5zb3J0KChhLCBiKSA9PiB7XG5cdFx0XHRcdFx0XHRyZXR1cm4gYS5sZW5ndGggPT09IGIubGVuZ3RoID8gYS5sb2NhbGVDb21wYXJlKGIpIDogYS5sZW5ndGggLSBiLmxlbmd0aDtcblx0XHRcdFx0XHR9KS5qb2luKCcsICcpLFxuXHRcdFx0XHRcdGFsaWFzZXM6IGFsaWFzZXMgPyBPYmplY3Qua2V5cyhhbGlhc2VzKSA6IG51bGxcblx0XHRcdFx0fSk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0ZW50cmllcy5zb3J0KChhLCBiKSA9PiBhLmxhYmVsLmxvY2FsZUNvbXBhcmUoYi5sYWJlbCkpO1xuXG5cdFx0cmV0dXJuIHtcblx0XHRcdGNvdW50OiBlbnRyaWVzLmxlbmd0aCxcblx0XHRcdGVudHJpZXNcblx0XHR9O1xuXHR9XG59XG4iXSwiZmlsZSI6InBhcnNlci9leHRlbnNpb24tbWFwLmpzIn0=
