"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
exports.renderHelp = renderHelp;

var _debug = _interopRequireDefault(require("../lib/debug"));

var _path = _interopRequireDefault(require("path"));

var _template = require("../render/template");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const {
  log
} = (0, _debug.default)('cli-kit:help');
const {
  highlight
} = _debug.default.styles;
/**
 * Renders help for a specific context, and its parent contexts, to a string. This function is
 * passed into the selected command's `action()` as a property called `help()` so that a command
 * can render its own help output.
 *
 * @param {Context} ctx - The context to render help.
 * @param {Object} [opts] - Various options to pass into `generateHelp()`.
 * @returns {String}
 */

async function renderHelp(ctx, opts = {}) {
  const file = ctx.get('helpTemplateFile', _path.default.resolve(__dirname, '..', '..', 'templates', 'help.tpl'));
  log(`Rendering help template: ${highlight(file)}`);
  return (0, _template.renderFile)(file, Object.assign({
    style: (opts === null || opts === void 0 ? void 0 : opts.styles) || {},
    header: null,
    footer: null
  }, await ctx.generateHelp(opts))).trim();
}
/**
 * The built-in help command parameters.
 *
 * @type {Object}
 */


var _default = {
  /**
   * Indicates this command is the built-in cli-kit help command so that if the CLI instance this
   * command belongs to gets added to another CLI instance, we don't copy it over.
   * @type {Boolean}
   */
  clikitHelp: true,

  /**
   * While this is a command, we don't want to show it since we already show the `--help` flag.
   * @type {Boolean}
   */
  hidden: true,

  /**
   * Output the help as JSON. Neato.
   * @type {Object}
   */
  options: {
    '--json': null
  },

  /**
   * Executes the help command.
   *
   * @param {Object} params - Various parameters.
   * @param {Object} [params.argv] - The parsed options.
   * @param {Array.<Context>} params.contexts - The stack of contexts found during parsing.
   * @param {Error} [params.err] - An error object in the event an error occurred.
   * @param {Function} params.exitCode - A function that sets the exit code.
   * @param {Array.<String>} [params.parentContextNames] - An array of parent context names.
   * @param {String} [params.unknownCommand] - The name of the unknown command.
   * @param {Array.<Error>} [params.warnings] - A list of warnings (error objects).
   * @returns {Promise}
   */
  async action(params = {}) {
    let {
      _ = [],
      argv = {},
      console,
      contexts,
      err,
      exitCode,
      parentContextNames,
      styles,
      warnings
    } = params;
    exitCode(+!!err); // 0=success, 1=error

    const formatError = err => {
      if (typeof err === 'string') {
        return {
          message: err
        };
      }

      const type = err && err.constructor && err.constructor.name || null;
      return err ? {
        code: err.code,
        message: !argv.json && type ? `${type}: ${err.message}` : err.message,
        meta: err.meta,
        stack: err.stack,
        type
      } : null;
    }; // skip the built-in help command and find the first context


    for (const ctx of contexts) {
      // we don't display help for the help command
      if (ctx.clikitHelp) {
        continue;
      } // generate the help object


      const help = await ctx.generateHelp({
        err,
        parentContextNames,
        warnings
      }); // check if we should error if passed an invalid command

      if (!err && _.length && (ctx.get('errorIfUnknownCommand') || argv.help)) {
        const unknownCommand = _[0];
        err = params.err = new Error(`Unknown command "${unknownCommand}"`);

        const {
          distance
        } = require('fastest-levenshtein');

        help.suggestions = help.commands.entries.map(cmd => ({
          name: cmd.name,
          desc: cmd.desc,
          dist: distance(unknownCommand, cmd.name)
        })).filter(s => s.dist <= 2).sort((a, b) => {
          const r = a.dist - b.dist;
          return r !== 0 ? r : a.name.localeCompare(b.name);
        });
      }

      help.error = formatError(err);
      help.warnings = Array.isArray(warnings) ? warnings.map(formatError) : null;
      const {
        _stdout,
        _stderr
      } = console; // print the help output

      if (argv.json) {
        _stdout.write(JSON.stringify(help, null, '  '));

        _stdout.write('\n');
      } else {
        const file = ctx.get('helpTemplateFile', _path.default.resolve(__dirname, '..', '..', 'templates', 'help.tpl'));
        log(`Rendering help template: ${highlight(file)}`);
        const buf = (0, _template.renderFile)(file, {
          style: styles,
          header: null,
          footer: null,
          ...help
        }).trim(); // determine the output stream

        (err ? _stderr : _stdout).write(buf);
        (err ? _stderr : _stdout).write('\n');
      } // set the exit code


      exitCode(err ? 1 : ctx.get('helpExitCode')); // we only loop until we hit the first valid context... generateHelp() will recurse
      // parent contexts for us

      break;
    }
  }

};
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbW1hbmRzL2hlbHAuanMiXSwibmFtZXMiOlsibG9nIiwiaGlnaGxpZ2h0IiwiZGVidWciLCJzdHlsZXMiLCJyZW5kZXJIZWxwIiwiY3R4Iiwib3B0cyIsImZpbGUiLCJnZXQiLCJwYXRoIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsIk9iamVjdCIsImFzc2lnbiIsInN0eWxlIiwiaGVhZGVyIiwiZm9vdGVyIiwiZ2VuZXJhdGVIZWxwIiwidHJpbSIsImNsaWtpdEhlbHAiLCJoaWRkZW4iLCJvcHRpb25zIiwiYWN0aW9uIiwicGFyYW1zIiwiXyIsImFyZ3YiLCJjb25zb2xlIiwiY29udGV4dHMiLCJlcnIiLCJleGl0Q29kZSIsInBhcmVudENvbnRleHROYW1lcyIsIndhcm5pbmdzIiwiZm9ybWF0RXJyb3IiLCJtZXNzYWdlIiwidHlwZSIsImNvbnN0cnVjdG9yIiwibmFtZSIsImNvZGUiLCJqc29uIiwibWV0YSIsInN0YWNrIiwiaGVscCIsImxlbmd0aCIsInVua25vd25Db21tYW5kIiwiRXJyb3IiLCJkaXN0YW5jZSIsInJlcXVpcmUiLCJzdWdnZXN0aW9ucyIsImNvbW1hbmRzIiwiZW50cmllcyIsIm1hcCIsImNtZCIsImRlc2MiLCJkaXN0IiwiZmlsdGVyIiwicyIsInNvcnQiLCJhIiwiYiIsInIiLCJsb2NhbGVDb21wYXJlIiwiZXJyb3IiLCJBcnJheSIsImlzQXJyYXkiLCJfc3Rkb3V0IiwiX3N0ZGVyciIsIndyaXRlIiwiSlNPTiIsInN0cmluZ2lmeSIsImJ1ZiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7OztBQUVBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFVLG9CQUFNLGNBQU4sQ0FBaEI7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBZ0JDLGVBQU1DLE1BQTVCO0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUNPLGVBQWVDLFVBQWYsQ0FBMEJDLEdBQTFCLEVBQStC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QUdxQyxPQUFILEdBQWFELE9BQWpCLEVBQTBCRSxLQUExQixDQUFnQyxJQUFoQztBQUNBLE9BL0MwQixDQWlEM0I7OztBQUNBckMsTUFBQUEsUUFBUSxDQUFDRCxHQUFHLEdBQUcsQ0FBSCxHQUFPdkIsR0FBRyxDQUFDRyxHQUFKLENBQVEsY0FBUixDQUFYLENBQVIsQ0FsRDJCLENBb0QzQjtBQUNBOztBQUNBO0FBQ0E7QUFDRDs7QUFoSGEsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBkZWJ1ZyBmcm9tICcuLi9saWIvZGVidWcnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5cbmltcG9ydCB7IHJlbmRlckZpbGUgfSBmcm9tICcuLi9yZW5kZXIvdGVtcGxhdGUnO1xuXG5jb25zdCB7IGxvZyB9ID0gZGVidWcoJ2NsaS1raXQ6aGVscCcpO1xuY29uc3QgeyBoaWdobGlnaHQgfSA9IGRlYnVnLnN0eWxlcztcblxuLyoqXG4gKiBSZW5kZXJzIGhlbHAgZm9yIGEgc3BlY2lmaWMgY29udGV4dCwgYW5kIGl0cyBwYXJlbnQgY29udGV4dHMsIHRvIGEgc3RyaW5nLiBUaGlzIGZ1bmN0aW9uIGlzXG4gKiBwYXNzZWQgaW50byB0aGUgc2VsZWN0ZWQgY29tbWFuZCdzIGBhY3Rpb24oKWAgYXMgYSBwcm9wZXJ0eSBjYWxsZWQgYGhlbHAoKWAgc28gdGhhdCBhIGNvbW1hbmRcbiAqIGNhbiByZW5kZXIgaXRzIG93biBoZWxwIG91dHB1dC5cbiAqXG4gKiBAcGFyYW0ge0NvbnRleHR9IGN0eCAtIFRoZSBjb250ZXh0IHRvIHJlbmRlciBoZWxwLlxuICogQHBhcmFtIHtPYmplY3R9IFtvcHRzXSAtIFZhcmlvdXMgb3B0aW9ucyB0byBwYXNzIGludG8gYGdlbmVyYXRlSGVscCgpYC5cbiAqIEByZXR1cm5zIHtTdHJpbmd9XG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZW5kZXJIZWxwKGN0eCwgb3B0cyA9IHt9KSB7XG5cdGNvbnN0IGZpbGUgPSBjdHguZ2V0KCdoZWxwVGVtcGxhdGVGaWxlJywgcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ3RlbXBsYXRlcycsICdoZWxwLnRwbCcpKTtcblx0bG9nKGBSZW5kZXJpbmcgaGVscCB0ZW1wbGF0ZTogJHtoaWdobGlnaHQoZmlsZSl9YCk7XG5cdHJldHVybiByZW5kZXJGaWxlKGZpbGUsIE9iamVjdC5hc3NpZ24oe1xuXHRcdHN0eWxlOiBvcHRzPy5zdHlsZXMgfHwge30sXG5cdFx0aGVhZGVyOiBudWxsLFxuXHRcdGZvb3RlcjogbnVsbFxuXHR9LCBhd2FpdCBjdHguZ2VuZXJhdGVIZWxwKG9wdHMpKSkudHJpbSgpO1xufVxuXG4vKipcbiAqIFRoZSBidWlsdC1pbiBoZWxwIGNvbW1hbmQgcGFyYW1ldGVycy5cbiAqXG4gKiBAdHlwZSB7T2JqZWN0fVxuICovXG5leHBvcnQgZGVmYXVsdCB7XG5cdC8qKlxuXHQgKiBJbmRpY2F0ZXMgdGhpcyBjb21tYW5kIGlzIHRoZSBidWlsdC1pbiBjbGkta2l0IGhlbHAgY29tbWFuZCBzbyB0aGF0IGlmIHRoZSBDTEkgaW5zdGFuY2UgdGhpc1xuXHQgKiBjb21tYW5kIGJlbG9uZ3MgdG8gZ2V0cyBhZGRlZCB0byBhbm90aGVyIENMSSBpbnN0YW5jZSwgd2UgZG9uJ3QgY29weSBpdCBvdmVyLlxuXHQgKiBAdHlwZSB7Qm9vbGVhbn1cblx0ICovXG5cdGNsaWtpdEhlbHA6IHRydWUsXG5cblx0LyoqXG5cdCAqIFdoaWxlIHRoaXMgaXMgYSBjb21tYW5kLCB3ZSBkb24ndCB3YW50IHRvIHNob3cgaXQgc2luY2Ugd2UgYWxyZWFkeSBzaG93IHRoZSBgLS1oZWxwYCBmbGFnLlxuXHQgKiBAdHlwZSB7Qm9vbGVhbn1cblx0ICovXG5cdGhpZGRlbjogdHJ1ZSxcblxuXHQvKipcblx0ICogT3V0cHV0IHRoZSBoZWxwIGFzIEpTT04uIE5lYXRvLlxuXHQgKiBAdHlwZSB7T2JqZWN0fVxuXHQgKi9cblx0b3B0aW9uczoge1xuXHRcdCctLWpzb24nOiBudWxsXG5cdH0sXG5cblx0LyoqXG5cdCAqIEV4ZWN1dGVzIHRoZSBoZWxwIGNvbW1hbmQuXG5cdCAqXG5cdCAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXMgLSBWYXJpb3VzIHBhcmFtZXRlcnMuXG5cdCAqIEBwYXJhbSB7T2JqZWN0fSBbcGFyYW1zLmFyZ3ZdIC0gVGhlIHBhcnNlZCBvcHRpb25zLlxuXHQgKiBAcGFyYW0ge0FycmF5LjxDb250ZXh0Pn0gcGFyYW1zLmNvbnRleHRzIC0gVGhlIHN0YWNrIG9mIGNvbnRleHRzIGZvdW5kIGR1cmluZyBwYXJzaW5nLlxuXHQgKiBAcGFyYW0ge0Vycm9yfSBbcGFyYW1zLmVycl0gLSBBbiBlcnJvciBvYmplY3QgaW4gdGhlIGV2ZW50IGFuIGVycm9yIG9jY3VycmVkLlxuXHQgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwYXJhbXMuZXhpdENvZGUgLSBBIGZ1bmN0aW9uIHRoYXQgc2V0cyB0aGUgZXhpdCBjb2RlLlxuXHQgKiBAcGFyYW0ge0FycmF5LjxTdHJpbmc+fSBbcGFyYW1zLnBhcmVudENvbnRleHROYW1lc10gLSBBbiBhcnJheSBvZiBwYXJlbnQgY29udGV4dCBuYW1lcy5cblx0ICogQHBhcmFtIHtTdHJpbmd9IFtwYXJhbXMudW5rbm93bkNvbW1hbmRdIC0gVGhlIG5hbWUgb2YgdGhlIHVua25vd24gY29tbWFuZC5cblx0ICogQHBhcmFtIHtBcnJheS48RXJyb3I+fSBbcGFyYW1zLndhcm5pbmdzXSAtIEEgbGlzdCBvZiB3YXJuaW5ncyAoZXJyb3Igb2JqZWN0cykuXG5cdCAqIEByZXR1cm5zIHtQcm9taXNlfVxuXHQgKi9cblx0YXN5bmMgYWN0aW9uKHBhcmFtcyA9IHt9KSB7XG5cdFx0bGV0IHsgXyA9IFtdLCBhcmd2ID0ge30sIGNvbnNvbGUsIGNvbnRleHRzLCBlcnIsIGV4aXRDb2RlLCBwYXJlbnRDb250ZXh0TmFtZXMsIHN0eWxlcywgd2FybmluZ3MgfSA9IHBhcmFtcztcblxuXHRcdGV4aXRDb2RlKCshIWVycik7IC8vIDA9c3VjY2VzcywgMT1lcnJvclxuXG5cdFx0Y29uc3QgZm9ybWF0RXJyb3IgPSBlcnIgPT4ge1xuXHRcdFx0aWYgKHR5cGVvZiBlcnIgPT09ICdzdHJpbmcnKSB7XG5cdFx0XHRcdHJldHVybiB7IG1lc3NhZ2U6IGVyciB9O1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCB0eXBlID0gZXJyICYmIGVyci5jb25zdHJ1Y3RvciAmJiBlcnIuY29uc3RydWN0b3IubmFtZSB8fCBudWxsO1xuXHRcdFx0cmV0dXJuIGVyciA/IHtcblx0XHRcdFx0Y29kZTogICAgZXJyLmNvZGUsXG5cdFx0XHRcdG1lc3NhZ2U6ICFhcmd2Lmpzb24gJiYgdHlwZSA/IGAke3R5cGV9OiAke2Vyci5tZXNzYWdlfWAgOiBlcnIubWVzc2FnZSxcblx0XHRcdFx0bWV0YTogICAgZXJyLm1ldGEsXG5cdFx0XHRcdHN0YWNrOiAgIGVyci5zdGFjayxcblx0XHRcdFx0dHlwZVxuXHRcdFx0fSA6IG51bGw7XG5cdFx0fTtcblxuXHRcdC8vIHNraXAgdGhlIGJ1aWx0LWluIGhlbHAgY29tbWFuZCBhbmQgZmluZCB0aGUgZmlyc3QgY29udGV4dFxuXHRcdGZvciAoY29uc3QgY3R4IG9mIGNvbnRleHRzKSB7XG5cdFx0XHQvLyB3ZSBkb24ndCBkaXNwbGF5IGhlbHAgZm9yIHRoZSBoZWxwIGNvbW1hbmRcblx0XHRcdGlmIChjdHguY2xpa2l0SGVscCkge1xuXHRcdFx0XHRjb250aW51ZTtcblx0XHRcdH1cblxuXHRcdFx0Ly8gZ2VuZXJhdGUgdGhlIGhlbHAgb2JqZWN0XG5cdFx0XHRjb25zdCBoZWxwID0gYXdhaXQgY3R4LmdlbmVyYXRlSGVscCh7IGVyciwgcGFyZW50Q29udGV4dE5hbWVzLCB3YXJuaW5ncyB9KTtcblxuXHRcdFx0Ly8gY2hlY2sgaWYgd2Ugc2hvdWxkIGVycm9yIGlmIHBhc3NlZCBhbiBpbnZhbGlkIGNvbW1hbmRcblx0XHRcdGlmICghZXJyICYmIF8ubGVuZ3RoICYmIChjdHguZ2V0KCdlcnJvcklmVW5rbm93bkNvbW1hbmQnKSB8fCBhcmd2LmhlbHApKSB7XG5cdFx0XHRcdGNvbnN0IHVua25vd25Db21tYW5kID0gX1swXTtcblx0XHRcdFx0ZXJyID0gcGFyYW1zLmVyciA9IG5ldyBFcnJvcihgVW5rbm93biBjb21tYW5kIFwiJHt1bmtub3duQ29tbWFuZH1cImApO1xuXG5cdFx0XHRcdGNvbnN0IHsgZGlzdGFuY2UgfSA9IHJlcXVpcmUoJ2Zhc3Rlc3QtbGV2ZW5zaHRlaW4nKTtcblx0XHRcdFx0aGVscC5zdWdnZXN0aW9ucyA9IGhlbHAuY29tbWFuZHMuZW50cmllc1xuXHRcdFx0XHRcdC5tYXAoY21kID0+ICh7IG5hbWU6IGNtZC5uYW1lLCBkZXNjOiBjbWQuZGVzYywgZGlzdDogZGlzdGFuY2UodW5rbm93bkNvbW1hbmQsIGNtZC5uYW1lKSB9KSlcblx0XHRcdFx0XHQuZmlsdGVyKHMgPT4gcy5kaXN0IDw9IDIpXG5cdFx0XHRcdFx0LnNvcnQoKGEsIGIpID0+IHtcblx0XHRcdFx0XHRcdGNvbnN0IHIgPSBhLmRpc3QgLSBiLmRpc3Q7XG5cdFx0XHRcdFx0XHRyZXR1cm4gciAhPT0gMCA/IHIgOiBhLm5hbWUubG9jYWxlQ29tcGFyZShiLm5hbWUpO1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0fVxuXG5cdFx0XHRoZWxwLmVycm9yID0gZm9ybWF0RXJyb3IoZXJyKTtcblx0XHRcdGhlbHAud2FybmluZ3MgPSBBcnJheS5pc0FycmF5KHdhcm5pbmdzKSA/IHdhcm5pbmdzLm1hcChmb3JtYXRFcnJvcikgOiBudWxsO1xuXG5cdFx0XHRjb25zdCB7IF9zdGRvdXQsIF9zdGRlcnIgfSA9IGNvbnNvbGU7XG5cblx0XHRcdC8vIHByaW50IHRoZSBoZWxwIG91dHB1dFxuXHRcdFx0aWYgKGFyZ3YuanNvbikge1xuXHRcdFx0XHRfc3Rkb3V0LndyaXRlKEpTT04uc3RyaW5naWZ5KGhlbHAsIG51bGwsICcgICcpKTtcblx0XHRcdFx0X3N0ZG91dC53cml0ZSgnXFxuJyk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRjb25zdCBmaWxlID0gY3R4LmdldCgnaGVscFRlbXBsYXRlRmlsZScsIHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICd0ZW1wbGF0ZXMnLCAnaGVscC50cGwnKSk7XG5cdFx0XHRcdGxvZyhgUmVuZGVyaW5nIGhlbHAgdGVtcGxhdGU6ICR7aGlnaGxpZ2h0KGZpbGUpfWApO1xuXG5cdFx0XHRcdGNvbnN0IGJ1ZiA9IHJlbmRlckZpbGUoZmlsZSwge1xuXHRcdFx0XHRcdHN0eWxlOiBzdHlsZXMsXG5cdFx0XHRcdFx0aGVhZGVyOiBudWxsLFxuXHRcdFx0XHRcdGZvb3RlcjogbnVsbCxcblx0XHRcdFx0XHQuLi5oZWxwXG5cdFx0XHRcdH0pLnRyaW0oKTtcblxuXHRcdFx0XHQvLyBkZXRlcm1pbmUgdGhlIG91dHB1dCBzdHJlYW1cblx0XHRcdFx0KGVyciA/IF9zdGRlcnIgOiBfc3Rkb3V0KS53cml0ZShidWYpO1xuXHRcdFx0XHQoZXJyID8gX3N0ZGVyciA6IF9zdGRvdXQpLndyaXRlKCdcXG4nKTtcblx0XHRcdH1cblxuXHRcdFx0Ly8gc2V0IHRoZSBleGl0IGNvZGVcblx0XHRcdGV4aXRDb2RlKGVyciA/IDEgOiBjdHguZ2V0KCdoZWxwRXhpdENvZGUnKSk7XG5cblx0XHRcdC8vIHdlIG9ubHkgbG9vcCB1bnRpbCB3ZSBoaXQgdGhlIGZpcnN0IHZhbGlkIGNvbnRleHQuLi4gZ2VuZXJhdGVIZWxwKCkgd2lsbCByZWN1cnNlXG5cdFx0XHQvLyBwYXJlbnQgY29udGV4dHMgZm9yIHVzXG5cdFx0XHRicmVhaztcblx0XHR9XG5cdH1cbn07XG4iXSwiZmlsZSI6ImNvbW1hbmRzL2hlbHAuanMifQ==
